(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;s.MessengerCommon=function(){this.BXIM={}};s.MessengerCommon.prototype.setBxIm=function(e){this.BXIM=e};s.MessengerCommon.prototype.isMobile=function(){return this.BXIM.mobileVersion};s.MessengerCommon.prototype.muteMessageChat=function(e,t,r){var i=0;var a=false;if(e.toString().substr(0,4)=="chat"){i=e.toString().substr(4);if(!this.BXIM.messenger.chat[i])return false}else{i=this.BXIM.messenger.userChat[e];if(!i)return false}r=r!=false;if(!this.BXIM.messenger.userChatBlockStatus[i])this.BXIM.messenger.userChatBlockStatus[i]={};if(t){this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=t}else{if(this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=="Y")this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]="N";else this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]="Y"}this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();if(r){s.localStorage.set("mcl2",{dialogId:e,mute:this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]},5);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:i,MUTE:this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}};s.MessengerCommon.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};s.MessengerCommon.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};s.MessengerCommon.prototype.isScrollMax=function(s,t){if(!s)return true;t=typeof t=="number"?t:0;if(this.isMobile()){var r=e.orientation==0?screen.height-125:screen.width-113;return document.body.scrollHeight-r-r/2<=s.scrollTop}else{return s.scrollHeight-s.offsetHeight-t<=s.scrollTop}};s.MessengerCommon.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};s.MessengerCommon.prototype.enableScroll=function(e,s,t){if(!e)return false;if(this.BXIM.messenger.isBodyScroll)return false;t=t!==false;s=400;return t&&this.isScrollMax(e,s)};s.MessengerCommon.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};s.MessengerCommon.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};s.MessengerCommon.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var a=i.top>=t;var n=i.bottom>t;if(r){return{top:a,bottom:n,coords:i}}else{return a||n}};s.MessengerCommon.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var a=i+s.clientHeight;var n=r.top>=0&&r.top<a;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{top:n,bottom:o}}else{return n||o}};s.MessengerCommon.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};s.MessengerCommon.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};s.MessengerCommon.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}return s.date.format(t,parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET")),this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),true)};s.MessengerCommon.prototype.getNowDate=function(e){var t=new Date;if(e==true)t=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);return Math.round(+t/1e3)+parseInt(s.message("USER_TZ_OFFSET"))};s.MessengerCommon.prototype.getDateDiff=function(e){var t=s.message("USER_TZ_OFFSET");if(t==="")return 0;var r=this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"));var i=parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET"));return r-i};s.MessengerCommon.prototype.isBlankAvatar=function(e){return e==""||e.indexOf(this.BXIM.pathToBlankImage)>=0};s.MessengerCommon.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};s.MessengerCommon.prototype.hideErrorImage=function(e){var s=e.src;if(e.parentNode&&e.parentNode.parentNode){e.parentNode.parentNode.className="";e.parentNode.parentNode.innerHTML='<a href="'+s+'" target="_blank">'+s+"</a>"}};s.MessengerCommon.prototype.prepareText=function(e,t,r,i,a){var n=e;t=t==true;r=r==true;i=i==true;a=a?a:false;n=s.util.trim(n);if(n.indexOf("/me")==0){n=n.substr(4);n="<i>"+n+"</i>"}else if(n.indexOf("/loud")==0){n=n.substr(6);n="<b>"+n+"</b>"}var o="&gt;&gt;";if(r&&n.indexOf(o)>=0){var l=false;var h=n.split("<br />");for(var m=0;m<h.length;m++){if(h[m].substring(0,o.length)==o){h[m]=h[m].replace(o,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++m<h.length&&h[m].substring(0,o.length)==o){h[m]=h[m].replace(o,"")}h[m-1]+="</div></div>";l=true}}n=h.join("<br />")}if(t){n=s.util.htmlspecialchars(n)}n=n.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,s,t){var i="";s=parseInt(s);if(r&&t&&s>0&&typeof BXIM!="undefined")i='<span class="bx-messenger-ajax '+(s==BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+t+"</span>";else i=t;return i});n=n.replace(/\[CHAT=([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,s,t){var i="";s=parseInt(s);if(r&&t&&s>0&&typeof BXIM!="undefined")i='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+s+'">'+t+"</span>";else i=t;return i});n=n.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,s,t){var i="";s=parseInt(s);if(r&&t&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+t+"</span>";else i=t;return i});if(r){n=n.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i,a){return(a>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"});n=n.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"})}if(t){n=n.replace(/\n/gi,"<br />")}n=n.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){n=n.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,r,i){if(!r.match(/\.(jpg|jpeg|png|gif)$/i)||r.indexOf("/docs/pub/")>0||r.indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span><br>'}else{return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+t+' target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span><br>'}})}if(a){n=n.replace(new RegExp("("+a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(this.BXIM.settings.enableBigSmile){n=n.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?width=")(\d+)("[^>]+?height=")(\d+)("[^>]+?class="bx-smile"\s*\/?>\s*)$/,function g(e,s,t,r,i,a){return s+parseInt(t,10)*2+r+parseInt(i,10)*2+a})}if(n.substr(-6)=="<br />"){n=n.substr(0,n.length-6)}n=n.replace(/<br><br \/>/gi,"<br />");n=n.replace(/<br \/><br>/gi,"<br />");return n};s.MessengerCommon.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("	");r=r.split("<br />").join("\n");return r};s.MessengerCommon.prototype.addMentionList=function(e,s,t){if(!e||!s)return false;if(!this.BXIM.messenger.mentionList[e])this.BXIM.messenger.mentionList[e]={};this.BXIM.messenger.mentionList[e][s]=t};s.MessengerCommon.prototype.prepareMention=function(e,s){if(!this.BXIM.messenger.mentionList[e])return s;for(var t in this.BXIM.messenger.mentionList[e]){var r=this.BXIM.messenger.mentionList[e][t];if(r.toString().substr(0,4)=="chat"){s=s.split(t).join("[CHAT="+r.toString().substr(4)+"]"+t+"[/CHAT]")}else{s=s.split(t).join("[USER="+r+"]"+t+"[/USER]")}}this.clearMentionList(e);return s};s.MessengerCommon.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};s.MessengerCommon.prototype.getRecipientByChatId=function(e){var s=0;if(this.BXIM.messenger.chat[e]){s="chat"+e}else{for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}}return s};s.MessengerCommon.prototype.getUserIdByChatId=function(e){var s=0;for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}return s};s.MessengerCommon.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e.toString().substr(0,4)=="chat"){var r=e.toString().substr(4);if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,workPosition:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",fake:true};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){var i=parseInt(e)?this.BXIM.path.profileTemplate.replace("#user_id#",e):"";this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:i,status:"guest",workPosition:"",extranet:false,network:false,color:"#556574",fake:true};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v3.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};s.MessengerCommon.prototype.userInChat=function(e,s){if(!this.BXIM.messenger.userInChat[e])return false;if(typeof s=="undefined"){s=this.BXIM.userId}var t=false;if(typeof this.BXIM.messenger.userInChat[e].indexOf!="undefined"){if(this.BXIM.messenger.userInChat[e].indexOf(s.toString())!=-1||this.BXIM.messenger.userInChat[e].indexOf(parseInt(s))!=-1){t=true}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(parseInt(this.BXIM.messenger.userInChat[e][r])==parseInt(s)){t=true;break}}}return t};s.MessengerCommon.prototype.getUserStatus=function(e,t){if(!e||e.toString().substr(0,7)!="network"){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e}t=t===true;var r="";var i="";if(typeof this.BXIM.messenger.users[e]=="undefined"){r="guest";i=s.message("IM_STATUS_GUEST")}else if(this.BXIM.messenger.users[e].status=="offline"){r="offline";i=s.message("IM_STATUS_OFFLINE")}else if(this.BXIM.messenger.users[e].status=="guest"){r="guest";i=s.message("IM_STATUS_GUEST")}else if(this.BXIM.userId==e){r=this.BXIM.messenger.users[e].status?this.BXIM.messenger.users[e].status.toString():"";i=r?s.message("IM_STATUS_"+r.toUpperCase()):""}else if(this.getUserMobileStatus(e)){r="mobile";i=s.message("IM_STATUS_MOBILE")}else if(this.BXIM.messenger.users[e].idle>0){r="idle";i=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(this.BXIM.messenger.users[e].birthday&&(this.BXIM.messenger.users[e].status=="online"||this.BXIM.messenger.users[e].status=="offline")){r="birthday";if(this.BXIM.messenger.users[e].status=="offline"){i=s.message("IM_STATUS_OFFLINE")}else{i=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}}else{r=this.BXIM.messenger.users[e].status?this.BXIM.messenger.users[e].status.toString():"";i=s.message("IM_STATUS_"+r.toUpperCase())}return t?i:r};s.MessengerCommon.prototype.getUserIdle=function(e){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;var s="";if(this.BXIM.messenger.users[e].idle>0){var t=parseInt(this.BXIM.messenger.users[e].idle);s=this.formatDate(this.BXIM.messenger.users[e].idle,this.getNowDate()-t>=3600?"Hdiff":"idiff")}return s};s.MessengerCommon.prototype.getUserMobileStatus=function(e){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;var t=false;if(this.BXIM.messenger.users[e].mobileLastDate>0){var r=parseInt(this.BXIM.messenger.users[e].mobileLastDate);if(this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"))-(parseInt(r)+parseInt(s.message("SERVER_TZ_OFFSET")))<240){t=true}}return t};s.MessengerCommon.prototype.getUserPosition=function(e){var t="";if(!this.BXIM.messenger.users[e])return"";if(this.BXIM.messenger.users[e].workPosition){t=this.BXIM.messenger.users[e].workPosition}else if(this.BXIM.messenger.users[e].extranet){t=s.message("IM_CL_USER_EXTRANET")}else if(this.BXIM.bitrixIntranet){t=s.message("IM_CL_USER_B24")}else{t=s.message("IM_CL_USER")}return t};s.MessengerCommon.prototype.setColor=function(e,t){if(!this.BXIM.init&&this.BXIM.desktop.ready()){s.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:t}]);return false}if(typeof e!="string"){return false}else{e=e.toUpperCase()}if(typeof t!="undefined"){if(typeof this.BXIM.messenger.chat[t]=="undefined"){return false}}else{t=0;if(this.BXIM.userColor==e){return false}}s.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:t,sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(parseInt(e.CHAT_ID)==0){this.BXIM.userColor=e.COLOR;if(this.BXIM.desktop.run()){setTimeout(function(){s.desktop.setUserInfo(s.MessengerCommon.getUserParam())},500)}}}},this)})};s.MessengerCommon.prototype.renameChat=function(e,t){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!t||e<=0)return false;t=s.util.trim(t);if(t.length<=0||this.BXIM.messenger.chat[e].name==s.util.htmlspecialchars(t))return false;this.BXIM.messenger.chat[e].name=s.util.htmlspecialchars(t);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(!this.BXIM.ppServerStatus)s.PULL.updateState(true)},this)});return true};s.MessengerCommon.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}else{if(this.BXIM.messenger.popupMessenger==null)return false}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e)}else if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e);if(this.BXIM.messenger.recentListExternal){this.recentListRedraw(e)}}};s.MessengerCommon.prototype.contactListRedraw=function(e){e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactListShowed={};if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupContactListElementsWrap,{children:this.contactListPrepare()});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){s.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};s.MessengerCommon.prototype.contactListPrepareSearch=function(e,t,r,i){if(!t)return false;var a={groupOpen:true,viewOffline:true,viewGroup:true,viewChat:true,viewOpenChat:true,viewOfflineWithPhones:false,extra:false,searchText:r,callback:{empty:function(){}}};if(i!=false){for(var n in i){if(n=="timeout"||n=="params")continue;a[n]=i[n]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate(function(){t.innerHTML="";s.adjust(t,{children:this.contactListPrepare(a)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),o)}else{t.innerHTML="";s.adjust(t,{children:this.contactListPrepare(a)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};s.MessengerCommon.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};var t=[];var r=null;var i={};var a={};var n=[];var o={};var l=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var h=!(l!=null&&l.length==0);var m=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var g=typeof e.extra!="undefined"?e.extra:true;var I=typeof e.groupOpen!="undefined"?e.groupOpen:"auto";var M=typeof e.viewGroup!="undefined"?e.viewGroup:h||!this.BXIM.settings?false:this.BXIM.settings.viewGroup;var p=typeof e.viewOffline!="undefined"?e.viewOffline:h||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var c=typeof e.viewChat!="undefined"?e.viewChat:true;var d=typeof e.viewOpenChat!="undefined"?e.viewOpenChat:true;var u=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;var f=typeof e.callback!="undefined"?e.callback:{};if(typeof f.empty!="function"){f.empty=function(){}}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var B={};if(typeof e.exceptUsers!="undefined"){for(var X=0;X<e.exceptUsers.length;X++)B[e.exceptUsers[X]]=true}if(M){i=this.BXIM.messenger.groups;o=this.BXIM.messenger.userInGroup}else{i=this.BXIM.messenger.woGroups;o=this.BXIM.messenger.woUserInGroup}var E=0;for(var X in i)E++;if(E<=0&&!this.BXIM.messenger.contactListLoad){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}var b=[];var C=[];if(h){l=l+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var S=s.correctText(l);if(S!=l){C=S.split(" ")}}b=l.split(" ")}a[0]={id:0,name:s.message("IM_M_CL_UNREAD"),status:"open"};for(var X in this.BXIM.messenger.unreadMessage)n.push(X);o[0]={id:0,users:n};for(var X in i){if(X!="last"&&X!=0)a[X]=i[X]}if(c||d){var _=[];for(var X in this.BXIM.messenger.chat){if(!h&&this.BXIM.messenger.chat[X].type=="call")continue;if(d&&this.BXIM.messenger.chat[X].type=="open"){_.push(X)}else if(c){_.push(X)}}_.sort(s.delegate(function(e,s){X=this.BXIM.messenger.chat[e].name;ii=this.BXIM.messenger.chat[s].name;if(X<ii){return-1}else if(X>ii){return 1}else{return 0}},this));if(_.length>0){o["chat"]={id:"chat",users:_,isChat:true}}}else{delete o["chat"]}var T=this.recentListGetSortIndex();for(var X in a){var v=a[X];if(typeof v=="undefined"||!v.name||!s.type.isNotEmptyString(v.name))continue;if(!h&&v.id=="search")continue;var R=[];var L={};if(o[X]&&!o[X].isChat){var A=[];for(var x=0;x<o[X].users.length;x++){var y=this.BXIM.messenger.users[o[X].users[x]];if(typeof y=="undefined"||this.BXIM.userId==y.id||typeof y.name=="undefined"||B[y.id]||L[X+"_"+y.id])continue;L[X+"_"+y.id]=true;if(h){var w=y.name.toLowerCase()+(y.workPosition?(" "+y.workPosition).toLowerCase():"")+(y.searchMark?" "+y.searchMark:"");var N=false;for(var D=0;D<b.length;D++)if(w.indexOf(b[D].toLowerCase())<0)N=true;if(N){for(var D=0;D<C.length;D++){if(w.indexOf(C[D].toLowerCase())<0)N=true;else N=false}}if(N)continue}A.push(y.id)}A.sort(function(e,s){var t=T[e]?T[e]:0;var r=T[s]?T[s]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}});for(var x=0;x<A.length;x++){var y=this.BXIM.messenger.users[A[x]];var O="";var k="";if(g&&this.BXIM.messenger.unreadMessage[y.id]&&this.BXIM.messenger.unreadMessage[y.id].length>0){O="bx-messenger-cl-status-new-message";k='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[y.id].length<100?this.BXIM.messenger.unreadMessage[y.id].length:"99+")+"</span>"}var U="";if(g&&this.countWriting(y.id))U="bx-messenger-cl-status-writing";var P=this.getUserStatus(y.id);if(u&&y.phoneDevice&&P=="offline"){P="online"}if(!h&&X!="last"&&p==false&&P=="offline"&&O=="")continue;if(this.isMobile()){var G="mobile-cl-avatar-id-"+y.id+"-g-"+X;var H='id="'+G+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+y.avatar+'"';BitrixMobile.LazyLoad.registerImage(G)}else{var H='_src="'+y.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(h||v.status=="open"&&I=="auto"||I==true)H='src="'+y.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}var F=this.isBlankAvatar(y.avatar)?'style="background-color: '+y.color+'"':"";R.push(s.create("a",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-"+y.id+" bx-messenger-cl-status-"+P+" "+O+" "+U},attrs:{href:"#user"+y.id,"data-userId":y.id,"data-name":s.util.htmlspecialcharsback(y.name),"data-status":P,"data-avatar":y.avatar},html:'<span class="bx-messenger-cl-count">'+k+"</span>"+'<span class="bx-messenger-cl-avatar" title="'+y.name+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(y.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+H+" "+F+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(y.extranet?" bx-messenger-user-extranet":"")+'">'+(y.nameList?y.nameList:y.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+this.getUserPosition(y.id)+"</div>"+"</span>"}))}if(R.length>0){var W=s.create("div",{attrs:{"data-groupId-wrap":v.id},props:{className:"bx-messenger-cl-group"+(h||v.status=="open"&&I=="auto"||I==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":v.id,title:v.name},html:v.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:R})]});if(v.id=="search"){r=W}else{t.push(W)}}}else if(o[X]&&o[X].isChat){var j=[];for(var x=0;x<o[X].users.length;x++){var Y=this.BXIM.messenger.chat[o[X].users[x]];if(typeof Y=="undefined"||typeof Y.name=="undefined"||L[X+"_chat"+Y.id])continue;L[X+"_chat"+Y.id]=true;if(h){var N=false;for(var D=0;D<b.length;D++)if(Y.name.toLowerCase().indexOf(b[D].toLowerCase())<0)N=true;if(N){for(var D=0;D<C.length;D++){if(Y.name.toLowerCase().indexOf(C[D].toLowerCase())<0)N=true;else N=false}}if(N)continue}j.push(Y.id)}j.sort(function(e,s){var t=T["chat"+e]?T["chat"+e]:0;var r=T["chat"+s]?T["chat"+s]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}});for(var x=0;x<j.length;x++){var Y=this.BXIM.messenger.chat[j[x]];var U="";if(g&&this.countWriting("chat"+Y.id))U="bx-messenger-cl-status-writing";var O="";var k="";if(g&&this.BXIM.messenger.unreadMessage["chat"+Y.id]&&this.BXIM.messenger.unreadMessage["chat"+Y.id].length>0){O="bx-messenger-cl-status-new-message";k='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage["chat"+Y.id].length<100?this.BXIM.messenger.unreadMessage["chat"+Y.id].length:"99+")+"</span>"}if(this.isMobile()){var G="mobile-cl-avatar-id-chat-"+Y.id+"-g-"+X;var H='id="'+G+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+Y.avatar+'"';BitrixMobile.LazyLoad.registerImage(G)}else{var H='_src="'+Y.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(h||v.status=="open"&&I=="auto"||I==true)H='src="'+Y.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}var F=this.isBlankAvatar(Y.avatar)?'style="background-color: '+Y.color+'"':"";var K=F?"bx-messenger-cl-avatar-status-hide":"";var V=s.message("IM_CL_CHAT_2");if(Y.type=="call"){V=s.message("IM_CL_PHONE")}else if(Y.type=="open"){V=s.message("IM_CL_OPEN_CHAT")}R.push(s.create("span",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-chat"+Y.id+" bx-messenger-cl-status-online "+O+" "+U},attrs:{"data-userId":"chat"+Y.id,"data-userIsChat":"Y","data-name":Y.name,"data-status":"online","data-avatar":Y.avatar},html:'<span class="bx-messenger-cl-count">'+k+"</span>"+'<span class="bx-messenger-cl-avatar bx-messenger-cl-avatar-'+Y.type+" "+K+" "+(this.BXIM.messenger.generalChatId==Y.id?"bx-messenger-cl-item-chat-general":"")+'" title="'+Y.name+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(Y.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+H+" "+F+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(Y.extranet?" bx-messenger-user-extranet":"")+'">'+Y.name+"</div>"+'<div class="bx-messenger-cl-user-desc">'+V+"</div>"+"</span>"}))}if(R.length>0){var W=s.create("div",{attrs:{"data-groupId-wrap":v.id},props:{className:"bx-messenger-cl-group"+(h||v.status=="open"&&I=="auto"||I==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":v.id,title:v.name},html:v.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:R})]});if(v.id=="search"){r=W}else{t.push(W)}}}}if(this.BXIM.bitrixIntranet&&h){var q={};for(var X in this.BXIM.messenger.groups){var Z=true;for(var D=0;D<b.length;D++)if(this.BXIM.messenger.groups[X].name&&this.BXIM.messenger.groups[X].name.toLowerCase().indexOf(b[D].toLowerCase())>=0)Z=false;if(Z){for(var D=0;D<C.length;D++){if(this.BXIM.messenger.groups[X].name&&this.BXIM.messenger.groups[X].name.toLowerCase().indexOf(C[D].toLowerCase())>=0)Z=false}}if(!Z){q[X]={id:X,name:this.BXIM.messenger.groups[X].name,status:"close"}}}for(var X in q){var v=q[X];if(typeof v=="undefined"||!v.name||!s.type.isNotEmptyString(v.name))continue;var L={};var R=[];if(this.BXIM.messenger.userInGroup[X]&&!this.BXIM.messenger.userInGroup[X].isChat){for(var x=0;x<this.BXIM.messenger.userInGroup[X].users.length;x++){var y=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[X].users[x]];if(typeof y=="undefined"||this.BXIM.userId==y.id||typeof y.name=="undefined"||B[y.id]||L[X+"_"+y.id])continue;L[X+"_"+y.id]=true;var O="";var k="";if(g&&this.BXIM.messenger.unreadMessage[y.id]&&this.BXIM.messenger.unreadMessage[y.id].length>0){O="bx-messenger-cl-status-new-message";k='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[y.id].length<100?this.BXIM.messenger.unreadMessage[y.id].length:"99+")+"</span>"}var U="";if(g&&this.countWriting(y.id))U="bx-messenger-cl-status-writing";var P=this.getUserStatus(y.id);if(u&&y.phoneDevice&&P=="offline"){P="online"}if(X!="last"&&p==false&&P=="offline"&&O=="")continue;if(this.isMobile()){var G="mobile-cl-avatar-id-"+y.id+"-g-"+X;var H='id="'+G+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+y.avatar+'"';BitrixMobile.LazyLoad.registerImage(G)}else{var H='_src="'+y.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(v.status=="open"&&I=="auto"||I==true)H='src="'+y.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}var F=this.isBlankAvatar(y.avatar)?'style="background-color: '+y.color+'"':"";R.push(s.create("span",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-"+y.id+" bx-messenger-cl-status-"+P+" "+P+" "+O+" "+U},attrs:{"data-userId":y.id,"data-name":s.util.htmlspecialcharsback(y.name),"data-status":P,"data-avatar":y.avatar},html:'<span class="bx-messenger-cl-count">'+k+"</span>"+'<span class="bx-messenger-cl-avatar"  title="'+y.name+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(y.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+H+" "+F+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(y.extranet?" bx-messenger-user-extranet":"")+'">'+(y.nameList?y.nameList:y.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+this.getUserPosition(y.id)+"</div>"+"</span>"}))}if(R.length>0){t.push(s.create("div",{attrs:{"data-groupId-wrap":v.id},props:{className:"bx-messenger-cl-group"+(I==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":v.id,title:v.name},html:v.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:R})]}))}}}}if(r){t.push(r)}if(m){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-search"},html:s.message("IM_M_CL_SEARCH")}))}else if(t.length<=0){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}));f.empty()}return t};s.MessengerCommon.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();if(this.BXIM.messenger.contactList){s.MessengerCommon.recentListElementToTop(s.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"))}return s.PreventDefault(e)};s.MessengerCommon.prototype.contactListToggleGroup=function(){var e="";var t=s.findNextSibling(s.proxy_context,{className:"bx-messenger-cl-group-wrapper"});if(t.childNodes.length>0){var r=s.findChildrenByClassName(t,"bx-messenger-cl-avatar-img");if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].setAttribute("_src",r[i].src);r[i].src=this.BXIM.pathToBlankImage}}}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");

if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].src=r[i].getAttribute("_src");r[i].setAttribute("_src",this.BXIM.pathToBlankImage)}}}}else{if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}}var a=s.proxy_context.getAttribute("data-groupId");var n=this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length>0?false:this.BXIM.settings.viewGroup;if(n)this.BXIM.messenger.groups[a].status=e;else if(this.BXIM.messenger.woGroups[a])this.BXIM.messenger.woGroups[a].status=e;s.userOptions.save("IM","groupStatus",a,e);s.localStorage.set("mgp",{id:a,status:e},5)};s.MessengerCommon.prototype.contactListGetFromServer=function(){if(this.BXIM.messenger.contactListLoad)return false;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:!this.isMobile()&&this.BXIM.desktop&&this.BXIM.desktop.ready()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){for(var r in t.USERS)this.BXIM.messenger.users[r]=t.USERS[r];for(var r in t.GROUPS)this.BXIM.messenger.groups[r]=t.GROUPS[r];for(var r in t.CHATS){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHATS[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHATS[r].fake=true;this.BXIM.messenger.chat[r]=t.CHATS[r]}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}for(var r in t.WO_GROUPS)this.BXIM.messenger.woGroups[r]=t.WO_GROUPS[r];for(var r in t.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[r]=="undefined"){this.BXIM.messenger.woUserInGroup[r]=t.WO_USER_IN_GROUP[r]}else{for(var i=0;i<t.WO_USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.woUserInGroup[r].users.push(t.WO_USER_IN_GROUP[r].users[i]);this.BXIM.messenger.woUserInGroup[r].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[r].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewOfflineWithPhones:true})}}}else{this.BXIM.messenger.contactListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};s.MessengerCommon.prototype.contactListRealSearch=function(e,t){if(!this.BXIM.messenger.realSearch)return false;this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate(function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.BXIM.messenger.woUserInGroup["search"]={id:"search",users:[]};for(var s in e.USERS){if(this.BXIM.messenger.woUserInGroup["all"].users.indexOf(s)>=0)continue;this.BXIM.messenger.users[s]=e.USERS[s];this.BXIM.messenger.userInGroup["search"]["users"].push(s);this.BXIM.messenger.woUserInGroup["search"]["users"].push(s)}if(typeof t!="undefined"){t()}else if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}},this),onfailure:s.delegate(function(){this.BXIM.messenger.realSearchFound=true},this)})},this),1500)};s.MessengerCommon.prototype.contactListSearchClear=function(e){clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.userListRedraw()};s.MessengerCommon.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==38||e.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.contactListShowed={};if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(e.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.messenger.webrtc.callInit){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.contactListShowed={};if(e.keyCode==13){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.popupContactListSearchInput.value="";var t=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(t){this.recentListElementToTop(t.getAttribute("data-userId"));this.BXIM.openMessenger(t.getAttribute("data-userid"))}}}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.contactListRealSearch(this.BXIM.messenger.contactListSearchText)}this.userListRedraw()};s.MessengerCommon.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT"))return false;if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={}}if(this.BXIM.messenger.popupContactListActive){s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupContactListElementsWrap,{children:this.recentListPrepare(e)});if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML=this.BXIM.messenger.popupContactListElementsWrap.innerHTML}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}else if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML="";s.adjust(this.BXIM.messenger.recentListExternal,{children:this.recentListPrepare(e)})}};s.MessengerCommon.prototype.recentListPrepare=function(e){var t=[];var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}this.BXIM.messenger.recent.sort(function(e,s){var t=parseInt(e.date);var r=parseInt(s.date);if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});this.BXIM.messenger.recentListIndex=[];for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(typeof this.BXIM.messenger.recent[a].userIsChat=="undefined")this.BXIM.messenger.recent[a].userIsChat=this.BXIM.messenger.recent[a].recipientId.toString().substr(0,4)=="chat";var n=s.clone(this.BXIM.messenger.recent[a]);var o="";if(n.userIsChat){h=this.BXIM.messenger.chat[n.userId.toString().substr(4)];if(typeof h=="undefined"||typeof h.name=="undefined")continue;var l="chat"+h.id}else if(!i){var h=this.BXIM.messenger.users[n.userId];if(typeof h=="undefined"||this.BXIM.userId==h.id||typeof h.name=="undefined")continue;var l=h.id}else{continue}if(parseInt(n.date)>0){n.date=this.formatDate(n.date,this.getDateFormatType("RECENT_TITLE"));if(!r[n.date]){r[n.date]=true;t.push(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:n.date})]}))}}else{if(!r["never"]){r["never"]=true;t.push(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.push(this.drawContactListElement({id:l,data:h,text:n.text,textSenderId:n.senderId,textParams:n.params}));this.BXIM.messenger.recentListIndex.push(l)}if(t.length<=0){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};s.MessengerCommon.prototype.recentListAdd=function(e){if(!e.skipDateCheck){for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId&&parseInt(this.BXIM.messenger.recent[t].date)>parseInt(e.date))return false}}var r=[];r.push(e);for(var t=0;t<this.BXIM.messenger.recent.length;t++)if(this.BXIM.messenger.recent[t].userId!=e.userId)r.push(this.BXIM.messenger.recent[t]);this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(s.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};s.MessengerCommon.prototype.recentListHide=function(e,t){var r=[];for(var i=0;i<this.BXIM.messenger.recent.length;i++)if(this.BXIM.messenger.recent[i].userId!=e)r.push(this.BXIM.messenger.recent[i]);this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5);t=t!=false;if(t){s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});this.readMessage(e,true,true);if(e.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+e.substr(4)})}else{s.PULL.clearWatch("IM_PUBLIC_"+e.substr(4))}delete this.BXIM.messenger.showMessage[e]}this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(s.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:s.message("IM_M_EMPTY")}))}};s.MessengerCommon.prototype.recentListElementUpdate=function(e,s,t){if(e.toString().substr(0,4)=="chat"){for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].recipientId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}else{for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(!this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].recipientId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}};s.MessengerCommon.prototype.recentListElementToTop=function(e){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;this.BXIM.messenger.recent[r].date=s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"));break}}if(!t){var i="";var a=this.getLastMessageInDialog(e);if(a){if(a.text){i=a.text}else if(a.params&&a.params.FILE_ID.length>1){i="["+s.message("IM_F_FILE")+"]"}else if(a.params&&a.params.ATTACH.length>1){item.text="["+s.message("IM_F_ATTACH")+"]"}}if(!i){var n=this.getUserParam(e);if(n.type=="chat"){i=s.message("IM_CL_CHAT_2")}else if(n.type=="open"){i=s.message("IM_CL_OPEN_CHAT")}else if(n.type=="call"){i=s.message("IM_CL_PHONE")}else{i=this.getUserPosition(e)}}this.BXIM.messenger.recent.push({id:"tempSort"+ +new Date,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:e,senderId:e,text:s.MessengerCommon.prepareText(i,true),userId:e,params:{}})}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5)};s.MessengerCommon.prototype.recentListGetSortIndex=function(){var e={};var s=0;if(this.BXIM.messenger.recent.length<=0){this.recentListGetFromServer()}for(var t=0;t<this.BXIM.messenger.recent.length;t++){s=this.BXIM.messenger.recent.length-t;e[this.BXIM.messenger.recent[t].recipientId]=s}return e};s.MessengerCommon.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad)return false;this.BXIM.messenger.recentListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.recent=[];for(var r in t.RECENT){t.RECENT[r].date=parseInt(t.RECENT[r].date)-parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.recent.push(t.RECENT[r])}var i=false;for(var r in this.BXIM.messenger.unreadMessage){for(var a=0;a<this.BXIM.messenger.unreadMessage[r].length;a++){if(!i||i.SEND_DATE<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date){i={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].params}}}}if(i){this.recentListAdd({userId:i.RECIPIENT_ID.toString().substr(0,4)=="chat"?i.RECIPIENT_ID:i.USER_ID,id:i.ID,date:i.SEND_DATE,recipientId:i.RECIPIENT_ID,senderId:i.SENDER_ID,text:i.SEND_MESSAGE,params:i.PARAMS},true)}for(var r in t.CHAT){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHAT[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHAT[r].fake=true;this.BXIM.messenger.chat[r]=t.CHAT[r]}for(var r in t.USERS)this.BXIM.messenger.users[r]=t.USERS[r];if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();this.BXIM.messenger.smile=t.SMILE;this.BXIM.messenger.smileSet=t.SMILE_SET;this.BXIM.settingsNotifyBlocked=t.NOTIFY_BLOCKED;if(!this.isMobile())this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recent.length==0){this.chatListPrepare()}}else{this.BXIM.messenger.recentListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.recentListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(this.recentListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};s.MessengerCommon.prototype.drawContactListElement=function(e){e.userIsChat=e.id.toString().substr(0,4)=="chat";e.extraClass=e.extraClass||"";e.showLastMessage=e.showLastMessage===false?false:true;var t="";var r="";var i="";if(this.BXIM.messenger.unreadMessage[e.id]&&this.BXIM.messenger.unreadMessage[e.id].length>0){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[e.id].length<100?this.BXIM.messenger.unreadMessage[e.id].length:"99+")+"</span>"}var a="";if(this.countWriting(e.id))a="bx-messenger-cl-status-writing";if(!e.data.avatar)e.data.avatar=this.BXIM.pathToBlankImage;var n="";var o=e.data.avatar;var l="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==e.id){l="bx-messenger-cl-item-active "}var h="mobile-rc-avatar-id-"+e.data.id;n='id="'+h+'" data-src="'+e.data.avatar+'"';o=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(h)}var m="";if(this.BXIM.settings.viewLastMessage&&e.showLastMessage){if(this.BXIM.messenger.message[e.id]&&this.BXIM.messenger.message[e.id].text){e.text=this.BXIM.messenger.message[e.id].text}if(!e.text&&e.textParams&&e.textParams["FILE_ID"]&&e.textParams["FILE_ID"].length>0){e.text="["+s.message("IM_F_FILE")+"]"}else if(!e.text&&e.textParams&&e.textParams["ATTACH"]&&e.textParams["ATTACH"].length>0){e.text="["+s.message("IM_F_ATTACH")+"]"}var g="";if(e.textSenderId==this.BXIM.userId)g='<span class="bx-messenger-cl-user-reply"></span>';e.text=this.prepareText(e.text);e.text=e.text.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");e.text=e.text.replace(/\[[buis]\](.*?)\[\/[buis]\]/gi,"$1");e.text=e.text.replace(/<s>([^"]*)<\/s>/gi,"");e.text=e.text.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ");if(e.text.length<=0){e.text=s.message("IM_M_DELETED")}m=g+""+e.text}else{if(e.userIsChat){if(e.data.type=="call"){m=s.message("IM_CL_PHONE")}else if(e.data.type=="open"){m=s.message("IM_CL_OPEN_CHAT")}else{m=s.message("IM_CL_CHAT_2")}}else{m=this.getUserPosition(e.id)}}var I=this.isBlankAvatar(e.data.avatar)?'style="background-color: '+e.data.color+'"':"";var M=e.userIsChat&&I?"bx-messenger-cl-avatar-status-hide":"";return s.create("span",{props:{className:"bx-messenger-cl-item  bx-messenger-cl-id-"+(e.userIsChat?"chat":"")+e.data.id+" "+l+(e.userIsChat?"bx-messenger-cl-item-chat "+r+" "+a+" "+t+" "+(this.BXIM.messenger.generalChatId==e.data.id?"bx-messenger-cl-item-chat-general":""):"bx-messenger-cl-status-"+this.getUserStatus(e.data.id)+" "+r+" "+a)+" "+e.extraClass},attrs:{"data-userId":e.id,"data-name":s.util.htmlspecialcharsback(e.data.name),"data-status":this.getUserStatus(e.data.id),"data-avatar":e.data.avatar,"data-userIsChat":e.userIsChat},html:'<span class="bx-messenger-cl-count">'+i+"</span>"+'<span title="'+e.data.name+'" class="bx-messenger-cl-avatar '+(e.userIsChat?"bx-messenger-cl-avatar-"+e.data.type+" "+(this.BXIM.messenger.generalChatId==e.data.id?" bx-messenger-cl-item-chat-general":""):"")+" "+M+'">'+'<img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(e.data.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+o+'" '+n+" "+I+">"+'<span class="bx-messenger-cl-status"></span>'+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(e.data.extranet?" bx-messenger-user-extranet":"")+'">'+(e.data.nameList?e.data.nameList:e.data.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+m+"</div>"+"</span>"})};s.MessengerCommon.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT"))return false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupContactListElementsWrap,{children:this.chatListPrepare(e)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};s.MessengerCommon.prototype.chatListPrepare=function(e){var t=[];var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.contactListLoad){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var a=this.BXIM.messenger.popupContactListElementsSize;var n=46;var o=29;var l=26;var h=0;var m=3;var g=[{id:"open",name:s.message("IM_CTL_CHAT_OPEN"),title:s.message("IM_CL_CREATE_OPEN"),more:s.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet},{id:"chat",name:s.message("IM_CTL_CHAT_CHAT"),title:s.message("IM_CL_CREATE_CHAT"),more:s.message("IM_CL_MORE_CHAT")},{id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled},{id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")},{id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_EXTRANET")},{id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET")}];for(var I=0;I<g.length;I++){if(g[I].skip)continue;h++}var M=a-o*h;var p=parseInt(M/n);var c=Math.max(parseInt(M/h/n),m);var d=0;var u=0;for(var I=0;I<g.length;I++){g[I].countElement=0;if(g[I].skip)continue;g[I].countElement=c}var f=this.recentListGetSortIndex();var B={};var X=[];for(var I=0;I<g.length;I++){if(g[I].skip)continue;B[I]=[];if(g[I].id=="private"||g[I].id=="extranet"||g[I].id=="blocked"){for(var E in this.BXIM.messenger.users){if(this.BXIM.messenger.users.hasOwnProperty(E)){if(E==this.BXIM.userId)continue;var b=this.BXIM.messenger.userChat[E];if(g[I].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[b]||!this.BXIM.messenger.userChatBlockStatus[b][this.BXIM.userId]||this.BXIM.messenger.userChatBlockStatus[b][this.BXIM.userId]=="N"){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[b]&&this.BXIM.messenger.userChatBlockStatus[b][this.BXIM.userId]=="Y"){continue}}if(g[I].id=="extranet"){if(!this.BXIM.messenger.users[E].extranet)continue}else{if(this.BXIM.messenger.users[E].extranet)continue}if(f[E]){B[I].push(this.BXIM.messenger.users[E])}}}B[I].sort(function(e,s){var t=f[e.id]?f[e.id]:0;var r=f[s.id]?f[s.id]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}})}else if(g[I].id=="chat"||g[I].id=="open"||g[I].id=="call"){for(var b in this.BXIM.messenger.chat){if(this.BXIM.messenger.chat.hasOwnProperty(b)){if(this.BXIM.messenger.chat[b].type!=g[I].id){continue}if(this.BXIM.messenger.generalChatId==b&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}B[I].push(this.BXIM.messenger.chat[b])}}B[I].sort(s.delegate(function(e,s){var t=f["chat"+e.id]?f["chat"+e.id]:0;var r=f["chat"+s.id]?f["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==e.id){t=1e7}else if(this.BXIM.messenger.userChatBlockStatus[e.id]&&this.BXIM.messenger.userChatBlockStatus[e.id][this.BXIM.userId]=="Y"){t=-1}if(this.BXIM.messenger.generalChatId==s.id){r=1e7}else if(this.BXIM.messenger.userChatBlockStatus[r.id]&&this.BXIM.messenger.userChatBlockStatus[r.id][this.BXIM.userId]=="Y"){r=-1}if(t>r){return-1}else if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}if(g[I].countElement>B[I].length){d+=B[I].length;u+=g[I].countElement-B[I].length}else{X.push(I);d+=g[I].countElement}}if(d<p){var C=0;var S=X.length;for(var I=0;I<u;I++){if(X[C]&&g[X[C]]){g[X[C]].countElement=g[X[C]].countElement+1}C=C==S-1?0:C+1}}for(var I=0;I<g.length;I++){if(g[I].skip)continue;if(B[I].length<=0&&(g[I].id=="call"||g[I].id=="extranet"||g[I].id=="blocked"))continue;t.push(s.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[g[I].id=="call"||g[I].id=="blocked"?null:s.create("span",{attrs:{"data-type":g[I].id},props:{title:g[I].title,className:"bx-messenger-chatlist-group-add"}}),s.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:g[I].name})]}));if(B[I].length<=0){continue}var _=[];var T=1;for(var v=0;v<B[I].length;v++){var R=T<=g[I].countElement;T++;if(g[I].id=="private"||g[I].id=="extranet"){var L=B[I][v];_.push(this.drawContactListElement({id:L.id,data:L,showLastMessage:false,extraClass:R?"":"bx-messenger-hide"}))}else if(g[I].id=="chat"||g[I].id=="open"||g[I].id=="call"){var A=B[I][v];_.push(this.drawContactListElement({id:"chat"+A.id,data:A,showLastMessage:false,extraClass:R?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}}if(g[I].countElement<B[I].length){_.push(s.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[s.create("span",{attrs:{"data-id":g[I].id,"data-text":s.message("IM_CL_MORE").replace("#COUNT#",B[I].length-g[I].countElement),"data-title":g[I].more},props:{title:g[I].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[g[I].id]?s.message("IM_CL_HIDE"):s.message("IM_CL_MORE").replace("#COUNT#",B[I].length-g[I].countElement)})]}))}if(_.length>0){t.push(s.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[g[I].id]?" bx-messenger-chatlist-show-all":"")},children:_}))}}if(t.length<=0){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};s.MessengerCommon.prototype.drawMessage=function(e,t,r,i){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab||typeof t!="object"||e==0||!this.MobileActionEqual("DIALOG"))return false;i=i==true;r=i?false:r;if(t.senderId==this.BXIM.userId&&this.BXIM.messenger.popupMessengerLastMessage<t.id){this.BXIM.messenger.popupMessengerLastMessage=t.id}if(typeof t.params!="object"){t.params={}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"?true:false;var a=t.params&&t.params.IS_EDITED=="Y";var n=t.params&&t.params.IS_DELETED=="Y";var o=t.id.indexOf("temp")==0;var l=o&&t.retry;var h=t.senderId==0;var m=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");var g=this.BXIM.ppServerStatus;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call")g=false;var I=g&&typeof t.params.LIKE=="object"&&t.params.LIKE.length>0?t.params.LIKE.length:"";

var M=g&&typeof t.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,t.params.LIKE);var p=s.MessengerCommon.diskDrawFiles(t.chatId,t.params.FILE_ID);if(p.length>0){p=s.create("div",{props:{className:"bx-messenger-file-box"+(t.text!=""?" bx-messenger-file-box-with-message":"")},children:p})}else{p=null}var c=s.MessengerCommon.drawAttach(t.chatId,t.params.ATTACH);if(c.length>0){c=s.create("div",{props:{className:"bx-messenger-attach-box"},children:c})}else{c=null}var d=false;if(!p&&!c&&t.text.length<=0){d=true;B=true}if(t.system&&t.system=="Y"){h=true;t.senderId=0}var u=this.BXIM.messenger.users[t.senderId];if(!h&&typeof u=="undefined"){d=true;B=true}if(!this.BXIM.messenger.history[e])this.BXIM.messenger.history[e]=[];if(parseInt(t.id)>0)this.BXIM.messenger.history[e].push(t.id);if(!d){var f=0;var B=false;var X=false;if(this.BXIM.messenger.unreadMessage[e]&&s.util.in_array(t.id,this.BXIM.messenger.unreadMessage[e]))X=true}var E=false;var b=null;if(i){b=this.BXIM.messenger.popupMessengerBodyWrap.firstChild;if(b){if(s.hasClass(b,"bx-messenger-content-empty")||s.hasClass(b,"bx-messenger-content-load")){s.remove(b)}else if(s.hasClass(b,"bx-messenger-content-group")){b=b.nextSibling}}}else{b=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(b&&(s.hasClass(b,"bx-messenger-content-empty")||s.hasClass(b,"bx-messenger-content-load"))){s.remove(b)}else if(b&&s.hasClass(b,"bx-messenger-content-item-notify")){if(t.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(b);E=false;b=this.BXIM.messenger.popupMessengerBodyWrap.lastChild}else{E=true;b=this.BXIM.messenger.popupMessengerBodyWrap.lastChild.previousSibling}}}if(!d){var C=this.formatDate(t.date,this.getDateFormatType("MESSAGE_TITLE"));if(!s("bx-im-go-"+C)){var S=[];if(this.BXIM.desktop&&this.BXIM.desktop.run()){S=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+C,href:"#bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:C})]}else{S=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+C},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:C})]}var _=s.create("div",{props:{className:"bx-messenger-content-group"+(C==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:S});if(i){this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(_,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);b=_.nextSibling}else{if(E&&b.nextElementSibling){this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(_,b.nextElementSibling);b=_}else{this.BXIM.messenger.popupMessengerBodyWrap.appendChild(_)}}}if(!h&&b){if(t.senderId==b.getAttribute("data-senderId")&&parseInt(t.date)-300<parseInt(b.getAttribute("data-messageDate"))){var T=s.findChildByClassName(b,"bx-messenger-content-item-text-message");var v=[s.create("div",{props:{className:"bx-messenger-hr"}}),s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(n?" bx-messenger-message-deleted":" ")+(n||a?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true,!this.BXIM.messenger.openChatFlag||t.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)}),p,c]})];if(i){for(var R=0,L=v.length;R<L;R++){T.insertBefore(v[R],T.firstChild)}b.setAttribute("data-blockmessageid",t.id);if(g){var A=s.findChildByClassName(b,"bx-messenger-content-item-like");if(A){A.className="bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"");A.innerHTML="";s.adjust(A,{children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})}}}else{for(var R=0,L=v.length;R<L;R++){T.appendChild(v[R])}var x=s.findChildByClassName(b,"bx-messenger-content-item-date");x.innerHTML=o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"));if(l){this.drawProgessMessage(t.id,{title:s.message("IM_M_RETRY")})}else if(o){this.drawProgessMessage(t.id)}b.setAttribute("data-messageDate",t.date);b.setAttribute("data-messageId",t.id);b.setAttribute("data-senderId",t.senderId)}if(X)s.addClass(b,"bx-messenger-content-item-new");f=t.id;B=true}}}if(!B){if(b)f=b.getAttribute("data-messageId");if(h){var y=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageId":""+t.id+""}},false);if(!y){var w=s.create("div",{attrs:{"data-type":"system","data-senderId":t.senderId,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-system"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[typeof u=="undefined"?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar,style:this.isBlankAvatar(u.avatar)?"background-color: "+u.color:""}})]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{props:{className:"bx-messenger-message"+(n?" bx-messenger-message-deleted":"")+(n||a?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true)}),p,c]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!g?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]});if(t.system&&t.system=="Y"&&X)s.addClass(w,"bx-messenger-content-item-new")}}else if(t.senderId==this.BXIM.userId){var w=s.create("div",{attrs:{"data-type":"self","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar,style:this.isBlankAvatar(u.avatar)?"background-color: "+u.color:""}})]}),l?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":t.id,"data-chat":parseInt(t.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:o?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(n?" bx-messenger-message-deleted":" ")+(n||a?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true)}),p,c]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:l?s.message("IM_M_NOT_DELIVERED"):o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!g?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]})}else{var w=s.create("div",{attrs:{"data-type":"other","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-2"+(X?" bx-messenger-content-item-new":"")},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{attrs:{title:m?s.util.htmlspecialcharsback(u.name):""},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar,style:this.isBlankAvatar(u.avatar)?"background-color: "+u.color:""}})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(n?" bx-messenger-message-deleted":" ")+(n||a?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true,!this.BXIM.messenger.openChatFlag||t.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)}),p,c]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!g?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]})}}else if(d){w=s.create("div",{attrs:{id:"im-message-"+t.id,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(w&&(!B||d)){if(i)this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(w,b);else if(E&&b.nextElementSibling)this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(w,b.nextElementSibling);else this.BXIM.messenger.popupMessengerBodyWrap.appendChild(w)}if(!d&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight,r)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}return f};s.MessengerCommon.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};s.MessengerCommon.prototype.clearProgessMessage=function(e){var t=s("im-message-"+e);if(!t)return false;s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};s.MessengerCommon.prototype.startWriting=function(e,t){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate(function(){this.endWriting(e)},this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate(function(){this.endWriting(e,t)},this),29500)}};s.MessengerCommon.prototype.drawWriting=function(e,t){if(e==this.BXIM.userId)return false;if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)>0){var r=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.addClass(r[i],"bx-messenger-cl-status-writing")}var r=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.addClass(r[i],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||t&&this.BXIM.messenger.currentTab==t)){if(t){var a=[];for(var i in this.BXIM.messenger.writingList[t]){if(this.BXIM.messenger.writingList[t].hasOwnProperty(i)&&this.BXIM.messenger.users[i]){a.push(this.BXIM.messenger.users[i].name)}}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",a.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(e,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[e].name))}}}else if(!this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)==0){var r=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.removeClass(r[i],"bx-messenger-cl-status-writing")}var r=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.removeClass(r[i],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||this.BXIM.messenger.currentTab==t)){if(!t){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(e)}var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(n&&s.hasClass(n,"bx-messenger-content-item-notify")){if(!t&&this.BXIM.messenger.readedList[e]){this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-n.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this),complete:s.delegate(function(){s.remove(n)},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-n.offsetHeight;s.remove(n)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-n.offsetHeight;s.remove(n)}}}}}};s.MessengerCommon.prototype.endWriting=function(e,s){if(s){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s)};s.MessengerCommon.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus||t=="create")return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.BXIM.desktop.ready()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}},this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate(function(){this.endSendWriting(t)},this),3e4)}};s.MessengerCommon.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};s.MessengerCommon.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};s.MessengerCommon.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){if(this.BXIM.messenger.chat[e].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage[e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage[e]}s.MessengerCommon.userListRedraw()}else{s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.readMessage("chat"+t.CHAT_ID,true,false);if(this.BXIM.messenger.chat[e].type!="open"){delete this.BXIM.messenger.userInChat[t.CHAT_ID];delete this.BXIM.messenger.unreadMessage[t.CHAT_ID];delete this.BXIM.messenger.chat[t.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+t.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}delete this.BXIM.messenger.unreadMessage[t.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}s.MessengerCommon.userListRedraw();s.localStorage.set("mcl",t.CHAT_ID,5)}},this)})}};s.MessengerCommon.prototype.pullEvent=function(){s.addCustomEvent(this.isMobile()?"onPull-im":"onPullEvent-im",s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="generalChatId"){this.BXIM.messenger.generalChatId=t.ID}else if(e=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&t.BLOCK){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat ("+t.ALLOW+")");location.reload()}else if(this.BXIM.desktop&&this.BXIM.desktop.run()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat ("+t.ALLOW+")");s.desktop.windowReload()}}else if(e=="desktopOffline"){this.BXIM.desktopStatus=false}else if(e=="desktopOnline"){this.BXIM.desktopStatus=true}else if(e=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(t.userId,false,false)}else if(e=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage("chat"+t.chatId,false,false)}else if(e=="readMessageApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;t.date=parseInt(t.date)+parseInt(s.message("USER_TZ_OFFSET"));this.drawReadMessage(t.userId,t.lastId,t.date)}else if(e=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.startWriting(t.senderId,t.dialogId)}else if(e=="message"||e=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.BXIM.lastRecordId>=t.MESSAGE.id)return false;var r={};r.MESSAGE={};r.USERS_MESSAGE={};t.MESSAGE.date=parseInt(t.MESSAGE.date)+parseInt(s.message("USER_TZ_OFFSET"));for(var i in t.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)t.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])t.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=t.CHAT[i]}for(var i in t.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=t.USER_IN_CHAT[i]}for(var i in t.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=t.USER_BLOCK_CHAT[i]}var a={};for(var i in t.USERS){if(this.BXIM.messenger.users[i]&&this.BXIM.messenger.users[i].status!=t.USERS[i].status&&parseInt(t.MESSAGE.date)+180>s.MessengerCommon.getNowDate()){a[i]=this.BXIM.messenger.users[i].status;this.BXIM.messenger.users[i].status=t.USERS[i].status}}if(this.MobileActionEqual("RECENT")){for(var i in a){if(!this.BXIM.messenger.users[i])continue;var n=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+i);if(n!=null){for(var o=0;o<n.length;o++){s.removeClass(n[o],"bx-messenger-cl-status-"+a[i]);s.addClass(n[o],"bx-messenger-cl-status-"+s.MessengerCommon.getUserStatus(i));n[o].setAttribute("data-status",s.MessengerCommon.getUserStatus(i))}}var n=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+i);if(n!=null){for(var o=0;o<n.length;o++){s.removeClass(n[o],"bx-messenger-cl-status-"+a[i]);s.addClass(n[o],"bx-messenger-cl-status-"+s.MessengerCommon.getUserStatus(i));n[o].setAttribute("data-status",s.MessengerCommon.getUserStatus(i))}}}}n=null;r.USERS=t.USERS;if(this.MobileActionEqual("DIALOG")){for(var i in t.FILES){if(!this.BXIM.disk.files[t.CHAT_ID])this.BXIM.disk.files[t.CHAT_ID]={};if(this.BXIM.disk.files[t.CHAT_ID][i])continue;t.FILES[i].date=parseInt(t.FILES[i].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[t.CHAT_ID][i]=t.FILES[i]}}r.MESSAGE[t.MESSAGE.id]=t.MESSAGE;this.BXIM.lastRecordId=t.MESSAGE.id;if(t.MESSAGE.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0||this.BXIM.messenger.message[t.MESSAGE.id])return;this.readMessage(t.MESSAGE.recipientId,false,false);r.USERS_MESSAGE[t.MESSAGE.recipientId]=[t.MESSAGE.id];this.updateStateVar(r);s.MessengerCommon.recentListAdd({userId:t.MESSAGE.recipientId,id:t.MESSAGE.id,date:parseInt(t.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:t.MESSAGE.recipientId,senderId:t.MESSAGE.senderId,text:t.MESSAGE.text,params:t.MESSAGE.params},true)}else{r.UNREAD_MESSAGE={};r.UNREAD_MESSAGE[e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId]=[t.MESSAGE.id];r.USERS_MESSAGE[e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId]=[t.MESSAGE.id];if(e=="message")this.endWriting(t.MESSAGE.senderId);else this.endWriting(t.MESSAGE.senderId,t.MESSAGE.recipientId);this.updateStateVar(r);s.MessengerCommon.recentListAdd({userId:e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId,id:t.MESSAGE.id,date:parseInt(t.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:t.MESSAGE.recipientId,senderId:t.MESSAGE.senderId,text:t.MESSAGE.text,params:t.MESSAGE.params},true)}s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else if(e=="messageUpdate"||e=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.message[t.id]){if(!this.BXIM.messenger.message[t.id].params)this.BXIM.messenger.message[t.id].params={};var l=0;if(e=="messageDelete"){t.message=s.message("IM_M_DELETED");this.BXIM.messenger.message[t.id].params.IS_DELETED="Y"}else if(e=="messageUpdate"){this.BXIM.messenger.message[t.id].params=t.params}this.BXIM.messenger.message[t.id].text=t.text;if(t.type=="private"){l=t.fromUserId==this.BXIM.userId?t.toUserId:t.fromUserId;this.endWriting(l)}else{l="chat"+t.chatId;this.endWriting(t.senderId,l)}this.recentListElementUpdate(l,t.id,t.text);if(this.BXIM.messenger.currentTab==l&&s("im-message-"+t.id)){var h=s("im-message-"+t.id);s.addClass(h,e=="messageDelete"?"bx-messenger-message-edited bx-messenger-message-deleted":"bx-messenger-message-edited");h.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[t.id].text,false,true,true);if(e=="messageUpdate"){if(t.params&&t.params.ATTACH){var m=s.MessengerCommon.drawAttach(this.BXIM.messenger.message[t.id].chatId,t.params.ATTACH);if(m.length>0){if(s.hasClass(h.nextElementSibling,"bx-messenger-attach-box")){h.nextElementSibling.innerHTML="";s.adjust(h.nextElementSibling,{children:m})}else{m=s.create("div",{props:{className:"bx-messenger-attach-box"},children:m});if(h.nextElementSibling){h.parentNode.insertBefore(m,h.nextElementSibling)}else{h.parentNode.appendChild(m)}}}}else if(typeof t.params!="undefined"&&t.params==""){if(s.hasClass(h.nextElementSibling,"bx-messenger-attach-box")){s.remove(h.nextElementSibling)}}}s.addClass(h,"bx-messenger-message-edited-anim");if(h.nextSibling&&s.hasClass(h.nextSibling,"bx-messenger-file-box")){s.addClass(h.nextSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(h,"bx-messenger-message-edited-anim")},this),1e3)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw()}}else if(e=="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG"))return false;if(!this.BXIM.messenger.message[t.id])return false;if(this.BXIM.messenger.message[t.id].params&&this.BXIM.messenger.message[t.id].params.IS_DELETED=="Y")return false;this.BXIM.messenger.message[t.id].params=t.params;if(t.type=="private"){l=t.fromUserId==this.BXIM.userId?t.toUserId:t.fromUserId}else{l="chat"+t.chatId}var h=s("im-message-"+t.id);if(this.BXIM.messenger.currentTab==l&&h){if(t.params){if(t.params.ATTACH){var m=s.MessengerCommon.drawAttach(this.BXIM.messenger.message[t.id].chatId,t.params.ATTACH);if(m.length>0){if(h.nextElementSibling&&s.hasClass(h.nextElementSibling,"bx-messenger-attach-box")){h.nextElementSibling.innerHTML="";s.adjust(h.nextElementSibling,{children:m})}else{m=s.create("div",{props:{className:"bx-messenger-attach-box"},children:m});if(h.nextElementSibling){h.parentNode.insertBefore(m,h.nextElementSibling)}else{h.parentNode.appendChild(m)}}}}if(t.params.IS_EDITED=="Y"){s.addClass(h,"bx-messenger-message-edited")}}else if(typeof t.params!="undefined"&&t.params==""){if(h.nextElementSibling&&s.hasClass(h.nextElementSibling,"bx-messenger-attach-box")){s.remove(h.nextElementSibling)}}s.addClass(h,"bx-messenger-message-edited-anim");

if(h.nextSibling&&s.hasClass(h.nextSibling,"bx-messenger-file-box")){s.addClass(h.nextSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(h,"bx-messenger-message-edited-anim")},this),1e3)}}else if(e=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var g=s.util.in_array(this.BXIM.userId,t.users);var I=t.users.length>0?t.users.length:"";if(!this.BXIM.messenger.message[t.id]){return false}if(typeof this.BXIM.messenger.message[t.id].params!="object"){this.BXIM.messenger.message[t.id].params={}}this.BXIM.messenger.message[t.id].params.LIKE=t.users;if(s("im-message-"+t.id)){var M=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+t.id+""}},false);if(M){var p=s.findChildByClassName(M,"bx-messenger-content-item-like");if(p){var c=s.findChildByClassName(p,"bx-messenger-content-like-digit",false);var d=s.findChildByClassName(p,"bx-messenger-content-like-button",false);if(g){d.innerHTML=s.message("IM_MESSAGE_DISLIKE");s.addClass(p,"bx-messenger-content-item-liked")}else{d.innerHTML=s.message("IM_MESSAGE_LIKE");s.removeClass(p,"bx-messenger-content-item-liked")}if(I>0){c.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(c,"bx-messenger-content-like-digit-off")}else{c.setAttribute("title","");s.addClass(c,"bx-messenger-content-like-digit-off")}if(c.innerHTML<I){s.addClass(M.firstChild,"bx-messenger-content-item-plus-like");setTimeout(function(){s.removeClass(M.firstChild,"bx-messenger-content-item-plus-like")},500)}c.innerHTML=I}}}}else if(e=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[t.fileTmpId])return false;if(this.BXIM.disk.files[t.fileChatId]&&this.BXIM.disk.files[t.fileChatId][t.fileId]){t.fileParams["preview"]=this.BXIM.disk.files[t.fileChatId][t.fileId]["preview"]}if(!this.BXIM.disk.files[t.fileChatId])this.BXIM.disk.files[t.fileChatId]={};this.BXIM.disk.files[t.fileChatId][t.fileId]=t.fileParams;s.MessengerCommon.diskRedrawFile(t.fileChatId,t.fileId);if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(e=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var u in t.files){if(this.BXIM.disk.filesRegister[t.chatId]){delete this.BXIM.disk.filesRegister[t.chatId][t.files[u]]}if(this.BXIM.disk.files[t.chatId]){this.BXIM.disk.files[t.chatId][t.files[u]].status="error";s.MessengerCommon.diskRedrawFile(t.chatId,t.files[u])}delete this.BXIM.disk.filesProgress[u]}this.drawTab(this.getRecipientByChatId(t.chatId))}else if(e=="fileDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;delete this.BXIM.disk.files[t.chatId][t.fileId];this.drawTab(this.getRecipientByChatId(t.chatId))}else if(e=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId].name=t.chatTitle;this.BXIM.messenger.redrawChatHeader()}}else if(e=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(t.chatId,t.chatAvatar)}else if(e=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId].color=t.chatColor;this.BXIM.messenger.redrawChatHeader()}}else if(e=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var i in t.users)this.BXIM.messenger.users[i]=t.users[i];if(!this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId]={id:t.chatId,name:t.chatId,owner:t.chatOwner,extranet:t.chatExtranet,fake:true}}else{this.BXIM.messenger.chat[t.chatId].extranet=t.chatExtranet;if(this.BXIM.messenger.userInChat[t.chatId]){for(i=0;i<t.newUsers.length;i++)this.BXIM.messenger.userInChat[t.chatId].push(t.newUsers[i])}else this.BXIM.messenger.userInChat[t.chatId]=t.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(e=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(t.userId==this.BXIM.userId){this.readMessage("chat"+t.chatId,true,false);this.leaveFromChat(t.chatId,false);if(t.message.length>0)this.BXIM.openConfirm({title:s.util.htmlspecialchars(t.chatTitle),message:t.message})}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[t.chatId]||!this.BXIM.messenger.userInChat[t.chatId])return false;var f=[];for(var i=0;i<this.BXIM.messenger.userInChat[t.chatId].length;i++)if(this.BXIM.messenger.userInChat[t.chatId][i]!=t.userId)f.push(this.BXIM.messenger.userInChat[t.chatId][i]);this.BXIM.messenger.userInChat[t.chatId]=f;this.BXIM.messenger.redrawChatHeader()}}else if(e=="massDeleteMessage"){if(this.BXIM.notify.skipMassDelete){return true}for(var i in t.MESSAGE){if(t.MESSAGE[i]>0){delete this.BXIM.notify.notify[i];delete this.BXIM.notify.flashNotify[i];delete this.BXIM.notify.unreadNotify[E]}}this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(e=="notify"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.lastRecordId>=t.id)return false;t.date=parseInt(t.date)+parseInt(s.message("USER_TZ_OFFSET"));var r={};r.UNREAD_NOTIFY={};r.UNREAD_NOTIFY[t.id]=[t.id];this.BXIM.messenger.notify.notify[t.id]=t;this.BXIM.messenger.notify.flashNotify[t.id]=t.silent!="Y";if(t.settingName=="im|like"&&t.original_tag.substr(0,10)=="RATING|IM|"){var B=t.original_tag.split("|");if(this.BXIM.messenger.message[B[4]]&&this.BXIM.messenger.message[B[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete r.UNREAD_NOTIFY[t.id];this.BXIM.notify.flashNotify[t.id]=false;this.BXIM.notify.viewNotify(t.id)}}if(t.silent=="N")this.BXIM.notify.changeUnreadNotify(r.UNREAD_NOTIFY);s.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=t.id}else if(e=="readNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=0;t.lastId=parseInt(t.lastId);for(var i in this.BXIM.notify.unreadNotify){var X=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[i]];if(X&&X.type!=1&&X.id<=t.lastId){delete this.BXIM.notify.unreadNotify[i]}}this.BXIM.notify.updateNotifyCount(false)}else if(e=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;var E=parseInt(t.id);if(this.BXIM.notify.notify[E]){if(this.isMobile()){delete this.BXIM.notify.notify[E]}else{this.BXIM.notify.notify[E].confirmMessages=t.messages}}delete this.BXIM.notify.unreadNotify[E];delete this.BXIM.notify.flashNotify[E];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(e=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;var X=this.BXIM.notify.notify[t.id];if(X&&X.type!=1)delete this.BXIM.notify.unreadNotify[t.id];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}},this));s.addCustomEvent(this.isMobile()?"onPullOnline":"onPullOnlineEvent",s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="user_online"){if(this.BXIM.messenger.users[t.USER_ID]){var r=false;if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=0){this.BXIM.messenger.users[t.USER_ID].idle=0;r=true}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){if(!this.isMobile()&&this.BXIM.messenger.users[t.USER_ID].status=="offline"&&t.STATUS!="offline"){if(this.BXIM.messenger.getTrackStatus(t.USER_ID)){var i=this.getUserParam(t.USER_ID);this.BXIM.messenger.showNotifyBlock({senderId:t.USER_ID,recipientId:this.BXIM.userId,text:s.message("IM_M_ST_ONLINE_"+(i.gender=="F"?"F":"M")+(this.BXIM.bitrixIntranet?"_B24":""))})}}this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(typeof t.MOBILE_LAST_DATE!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].mobileLastDate!=t.MOBILE_LAST_DATE){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=t.MOBILE_LAST_DATE;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();this.userListRedraw()}}}else if(e=="user_offline"){if(this.BXIM.messenger.users[t.USER_ID]&&this.BXIM.messenger.users[t.USER_ID].status!="offline"){this.BXIM.messenger.users[t.USER_ID].status="offline";this.BXIM.messenger.users[t.USER_ID].idle=0;this.BXIM.messenger.users[t.USER_ID].mobileLastDate=0;this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}else if(e=="user_status"){if(this.BXIM.messenger.users[t.USER_ID]){var r=false;if(typeof t.IDLE!="undefined"){if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=t.IDLE){this.BXIM.messenger.users[t.USER_ID].idle=t.IDLE;r=true}}if(typeof t.MOBILE_LAST_DATE!="undefined"){if(typeof this.BXIM.messenger.users[t.USER_ID].mobileLastDate=="undefined"){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=0}if(this.BXIM.messenger.users[t.USER_ID].mobileLastDate!=t.MOBILE_LAST_DATE){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=t.MOBILE_LAST_DATE;r=true}}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(typeof t.COLOR!="undefined"){if(this.BXIM.messenger.users[t.USER_ID]&&this.BXIM.messenger.users[t.USER_ID].color!=t.COLOR&&t.COLOR!=""){this.BXIM.messenger.users[t.USER_ID].color=t.COLOR;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}}else if(e=="online_list"){var r=false;for(var a in this.BXIM.messenger.users){if(typeof t.USERS[a]=="undefined"){if(this.BXIM.messenger.users[a].status!="offline"){this.BXIM.messenger.users[a].status="offline";this.BXIM.messenger.users[a].idle=0;this.BXIM.messenger.users[a].mobileLastDate=0;r=true}}else{if(typeof t.USERS[a].idle!="undefined"){if(typeof this.BXIM.messenger.users[a].idle=="undefined"){this.BXIM.messenger.users[a].idle=0}if(this.BXIM.messenger.users[a].idle!=t.USERS[a].idle){this.BXIM.messenger.users[a].idle=t.USERS[a].idle;r=true}}if(typeof t.USERS[a].mobileLastDate!="undefined"){if(typeof this.BXIM.messenger.users[a].mobileLastDate=="undefined"){this.BXIM.messenger.users[a].mobileLastDate=0}if(this.BXIM.messenger.users[a].mobileLastDate!=t.USERS[a].mobileLastDate){this.BXIM.messenger.users[a].mobileLastDate=t.USERS[a].mobileLastDate;r=true}}if(typeof t.USERS[a].status!="undefined"){if(this.BXIM.messenger.users[a].status!=t.USERS[a].status){this.BXIM.messenger.users[a].status=t.USERS[a].status;r=true}}}}if(r){this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}},this))};s.MessengerCommon.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)e.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])e.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var a=0;a<e.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.WO_USER_IN_GROUP!="undefined"){for(var i in e.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[i]=="undefined"){this.BXIM.messenger.woUserInGroup[i]=e.WO_USER_IN_GROUP[i]}else{for(var a=0;a<e.WO_USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.woUserInGroup[i].users.push(e.WO_USER_IN_GROUP[i].users[a]);this.BXIM.messenger.woUserInGroup[i].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[i].users)}}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,t);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate(function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=e.USERS_MESSAGE[i];for(var a=0;a<e.USERS_MESSAGE[i].length;a++){if(!s.util.in_array(e.USERS_MESSAGE[i][a],this.BXIM.messenger.showMessage[i])){this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][a]);if(this.BXIM.messenger.history[i])this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);else this.BXIM.messenger.history[i]=e.USERS_MESSAGE[i];if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG"))this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]])}}}}};s.MessengerCommon.prototype.changeUnreadMessage=function(e,t){t=t!=false;var r=false;var i=false;var a=true;var n=this.isMobile()?"online":this.BXIM.settings.status;for(var o in e){if(o.toString().substr(0,4)=="chat"){if(!s.MessengerCommon.userInChat(o.toString().substr(4))){continue}}var l=false;if(this.BXIM.xmppStatus&&o.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus())){i=true;if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}l=true}if(!l){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus()){if(typeof this.BXIM.messenger.flashMessage[o]=="undefined")this.BXIM.messenger.flashMessage[o]={};for(var h=0;h<e[o].length;h++){if(this.BXIM.isFocus())this.BXIM.messenger.flashMessage[o][e[o][h]]=false;if(this.BXIM.messenger.message[e[o][h]]&&this.BXIM.messenger.message[e[o][h]].senderId==this.BXIM.messenger.currentTab)r=true}this.readMessage(o,true,true,true)}else if(this.isMobile()&&this.BXIM.messenger.currentTab==o){var m=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate(function(e){if(e){s.MessengerCommon.readMessage(m,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[m])this.BXIM.messenger.unreadMessage[m]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[m],e[m]));else this.BXIM.messenger.unreadMessage[m]=e[m]}else{i=true;if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o];if(typeof this.BXIM.messenger.flashMessage[o]=="undefined"){this.BXIM.messenger.flashMessage[o]={};for(var h=0;h<e[o].length;h++){var g=this.BXIM.messenger.message[e[o][h]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||g){this.BXIM.messenger.flashMessage[o][e[o][h]]=t}}}else{for(var h=0;h<e[o].length;h++){var g=this.BXIM.messenger.message[e[o][h]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||g){if(!t&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[o][e[o][h]]=false}else{if(typeof this.BXIM.messenger.flashMessage[o][e[o][h]]=="undefined")this.BXIM.messenger.flashMessage[o][e[o][h]]=true}}}}}}var I=false;for(var h=0;h<e[o].length;h++){if(!I||I.SEND_DATE<=parseInt(this.BXIM.messenger.message[e[o][h]].date)+parseInt(s.message("SERVER_TZ_OFFSET"))){I={ID:this.BXIM.messenger.message[e[o][h]].id,SEND_DATE:parseInt(this.BXIM.messenger.message[e[o][h]].date)+parseInt(s.message("SERVER_TZ_OFFSET")),RECIPIENT_ID:this.BXIM.messenger.message[e[o][h]].recipientId,SENDER_ID:this.BXIM.messenger.message[e[o][h]].senderId,USER_ID:this.BXIM.messenger.message[e[o][h]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[e[o][h]].text,PARAMS:this.BXIM.messenger.message[e[o][h]].params}}}if(I){s.MessengerCommon.recentListAdd({userId:I.RECIPIENT_ID.toString().substr(0,4)=="chat"?I.RECIPIENT_ID:I.USER_ID,id:I.ID,date:I.SEND_DATE,recipientId:I.RECIPIENT_ID,senderId:I.SENDER_ID,text:I.SEND_MESSAGE,params:I.PARAMS},true)}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o){a=true}}if(a){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&i)s.MessengerCommon.userListRedraw();if(this.isMobile()&&this.MobileActionEqual("RECENT")&&app.enableInVersion(13)){clearTimeout(this.newMessageTimeout);this.newMessageTimeout=setTimeout(s.proxy(function(){this.BXIM.messenger.newMessage()},this),1e3)}else if(!this.isMobile()){this.BXIM.messenger.newMessage(t);this.BXIM.messenger.updateMessageCount(t);if(t&&r&&n!="dnd"){this.BXIM.playSound("newMessage2")}}};s.MessengerCommon.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;if(typeof this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName=="undefined")return false;var e={};var t=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var r=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var i=0;i<t.length;i++){e=s.MessengerCommon.isElementCoordsBelow(t[i],this.BXIM.messenger.popupMessengerBody,33,true);if(t[i].className!="bx-messenger-content-group bx-messenger-content-group-today"){t[i].className="bx-messenger-content-group "+(e.top?"":"bx-messenger-content-group-float");t[i].firstChild.nextSibling.style.marginLeft=e.top?"":Math.round(t[i].offsetWidth/2-t[i].firstChild.nextSibling.offsetWidth/2)+"px";t[i].firstChild.nextSibling.style.marginTop=e.top?"":-e.coords.top+14+"px"}if(!e.top&&t[i-1]){t[i-1].className="bx-messenger-content-group";t[i-1].firstChild.nextSibling.style.marginLeft="";t[i-1].firstChild.nextSibling.style.marginTop=""}}};s.MessengerCommon.prototype.unreadMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e];var r="";if(t.recipientId.toString().substr(0,4)=="chat"){r=t.recipientId}else{r=t.senderId}showMessage=this.BXIM.messenger.showMessage[r];showMessage.sort(function(e,s){if(e<s){return-1}else if(e>s){return 1}else{return 0}});var i=0;this.BXIM.messenger.unreadMessage[r]=[];for(var a=0;a<showMessage.length;a++){if(showMessage[a]>=e){if(!this.BXIM.messenger.unreadMessage[r])this.BXIM.messenger.unreadMessage[r]=[];this.BXIM.messenger.unreadMessage[r].push(showMessage[a])}else{i=showMessage[a]}}this.skipReadMessage=true;this.drawTab();this.userListRedraw();setTimeout(s.delegate(function(){this.skipReadMessage=false},this),1e3);console.log("unread message - chat:",t.chatId,"messageId:",e,"lastId:",i)};s.MessengerCommon.prototype.readMessage=function(t,r,i,a){if(!t||this.skipReadMessage)return false;a=a==true;if(!a&&(!this.BXIM.messenger.unreadMessage[t]||this.BXIM.messenger.unreadMessage[t].length<=0))return false;r=r!=false;i=i!==false;if(this.BXIM.messenger.recentListExternal){var n=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+t);if(n!=null)for(var o=0;o<n.length;o++)n[o].firstChild.innerHTML=""}if(this.BXIM.messenger.popupMessenger!=null){var n=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+t);if(n!=null)for(var o=0;o<n.length;o++)n[o].firstChild.innerHTML="";n=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(n!=null)for(var o=0;o<n.length;o++)if(n[o].getAttribute("data-notifyType")!=1)s.removeClass(n[o],"bx-messenger-content-item-new")}var l=0;if(Math&&this.BXIM.messenger.unreadMessage[t])l=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t])delete this.BXIM.messenger.unreadMessage[t];if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r)}if(i){clearTimeout(this.BXIM.messenger.readMessageTimeout[t+"_"+this.BXIM.messenger.currentTab]);this.BXIM.messenger.readMessageTimeout[t+"_"+this.BXIM.messenger.currentTab]=setTimeout(s.delegate(function(){var r={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(l)>0)r["LAST_ID"]=l;var i=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:r,onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR!=""){if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;try{if(typeof i=="object"&&i.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(t){}},this)})},this),200)}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};s.MessengerCommon.prototype.drawReadMessage=function(e,t,r,i){var a=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(a!=t||this.BXIM.messenger.message[a].senderId==e){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};s.MessengerCommon.prototype.drawNotifyMessage=function(e,t,r,i){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab||typeof r=="undefined"||typeof t=="undefined"||e==0)return false;var a=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!a||s.hasClass(a,"bx-messenger-content-empty"))return false;var n=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+t+'"></span>'+this.prepareText(r,false,true,true)})]})]})]});if(s.hasClass(a,"bx-messenger-content-item-notify"))s.remove(a);this.BXIM.messenger.popupMessengerBodyWrap.appendChild(n);i=i!=false;if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport&&i){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};s.MessengerCommon.prototype.loadHistory=function(e,t){t=typeof t=="undefined"?true:t;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var r=[];if(t){r=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item-text")}else{r=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&r.length<20){return false}if(r.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(r.length/20)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var i=null;if(!this.isMobile()){i=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(i)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(i,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(i)s.remove(i);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;return}for(var a in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][a])continue;r.FILES[a].date=parseInt(r.FILES[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[r.CHAT_ID][a]=r.FILES[a]}var n=0;for(var a in r.MESSAGE){r.MESSAGE[a].date=parseInt(r.MESSAGE[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[a]=r.MESSAGE[a];n++}if(n<20){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var a in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[a])this.BXIM.messenger.history[a]=s.util.array_merge(this.BXIM.messenger.history[a],r.USERS_MESSAGE[a]);else this.BXIM.messenger.history[a]=r.USERS_MESSAGE[a]}else{if(this.BXIM.messenger.showMessage[a])this.BXIM.messenger.showMessage[a]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[a],this.BXIM.messenger.showMessage[a]));else this.BXIM.messenger.showMessage[a]=r.USERS_MESSAGE[a]}}if(t){for(var a=0;a<r.USERS_MESSAGE[e].length;a++){var o=this.BXIM.messenger.message[r.USERS_MESSAGE[e][a]];if(o){if(s("im-message-history-"+o.id))continue;var l=s.MessengerCommon.formatDate(o.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));if(!s("bx-im-history-"+l)){var h=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+l},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:l})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(h)}var o=this.BXIM.messenger.drawMessageHistory(o);if(o)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(o)}}}else{var m=this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling;m=s("im-message-"+m.getAttribute("data-blockmessageid"));for(var a=0;a<r.USERS_MESSAGE[e].length;a++){var o=this.BXIM.messenger.message[r.USERS_MESSAGE[e][a]];if(o){if(s("im-message-"+o.id))continue;s.MessengerCommon.drawMessage(e,o,false,true)}}this.BXIM.messenger.popupMessengerBody.scrollTop=m.offsetTop-this.BXIM.messenger.popupMessengerBody.offsetTop-m.offsetHeight-100}},this),onfailure:s.delegate(function(){if(i)s.remove(i);if(this.isMobile())app.pullDownLoadingStop()},this)})}};s.MessengerCommon.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}for(var r in t.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[r]=="undefined"){this.BXIM.messenger.woUserInGroup[r]=t.WO_USER_IN_GROUP[r]}else{for(var i=0;i<t.WO_USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.woUserInGroup[r].users.push(t.WO_USER_IN_GROUP[r].users[i]);this.BXIM.messenger.woUserInGroup[r].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[r].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}}},this)})};s.MessengerCommon.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,
method:"POST",dataType:"json",timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}for(var t in e.USERS){this.BXIM.messenger.users[t]=e.USERS[t]}for(var t in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[t]=="undefined"){this.BXIM.messenger.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var r=0;r<e.USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[r]);this.BXIM.messenger.userInGroup[t].users=s.util.array_unique(this.BXIM.messenger.userInGroup[t].users)}}for(var t in e.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[t]=="undefined"){this.BXIM.messenger.woUserInGroup[t]=e.WO_USER_IN_GROUP[t]}else{for(var r=0;r<e.WO_USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.woUserInGroup[t].users.push(e.WO_USER_IN_GROUP[t].users[r]);this.BXIM.messenger.woUserInGroup[t].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[t].users)}}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}this.drawTab(this.BXIM.messenger.currentTab)}}},this)})};s.MessengerCommon.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[t];this.BXIM.messenger.loadLastMessageTimeout[t]=true;var i=s.delegate(function(){if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;s.MessengerCommon.loadLastMessage(t,r)},2e3);return true}this.BXIM.messenger.loadLastMessageTimeout[t]=false;this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.redrawTab[t]=true;this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var e=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:e});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(s.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}},this);var a=s.delegate(function(a){if(!this.BXIM.checkRevision(this.isMobile()?a.MOBILE_REVISION:a.REVISION))return false;this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(!a){i();return false}if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){if(!r){this.BXIM.messenger.userChat[t]=a.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var n in a.USERS){this.BXIM.messenger.users[n]=a.USERS[n]}for(var n in a.PHONES){this.BXIM.messenger.phones[n]={};for(var o in a.PHONES[n]){this.BXIM.messenger.phones[n][o]=s.util.htmlspecialcharsback(a.PHONES[n][o])}}for(var n in a.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[n]=="undefined"){this.BXIM.messenger.userInGroup[n]=a.USER_IN_GROUP[n]}else{for(var o=0;o<a.USER_IN_GROUP[n].users.length;o++)this.BXIM.messenger.userInGroup[n].users.push(a.USER_IN_GROUP[n].users[o]);this.BXIM.messenger.userInGroup[n].users=s.util.array_unique(this.BXIM.messenger.userInGroup[n].users)}}for(var n in a.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[n]=="undefined"){this.BXIM.messenger.woUserInGroup[n]=a.WO_USER_IN_GROUP[n]}else{for(var o=0;o<a.WO_USER_IN_GROUP[n].users.length;o++)this.BXIM.messenger.woUserInGroup[n].users.push(a.WO_USER_IN_GROUP[n].users[o]);this.BXIM.messenger.woUserInGroup[n].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[n].users)}}for(var n in a.READED_LIST){a.READED_LIST[n].date=parseInt(a.READED_LIST[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.readedList[n]=a.READED_LIST[n]}if(!r&&a.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var n in a.FILES){if(!this.BXIM.messenger.disk.files[a.CHAT_ID])this.BXIM.messenger.disk.files[a.CHAT_ID]={};a.FILES[n].date=parseInt(a.FILES[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[a.CHAT_ID][n]=a.FILES[n]}this.BXIM.messenger.sendAjaxTry=0;var l=0;for(var n in a.MESSAGE){l++;a.MESSAGE[n].date=parseInt(a.MESSAGE[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[n]=a.MESSAGE[n];this.BXIM.lastRecordId=parseInt(n)>this.BXIM.lastRecordId?parseInt(n):this.BXIM.lastRecordId}if(l<=0)delete this.BXIM.messenger.redrawTab[a.USER_ID];for(var n in a.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(a.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=a.USERS_MESSAGE[n]}if(r&&this.BXIM.messenger.chat[a.USER_ID.substr(4)].fake){this.BXIM.messenger.chat[a.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var n in a.CHAT){this.BXIM.messenger.chat[n]=a.CHAT[n]}for(var n in a.USER_IN_CHAT){this.BXIM.messenger.userInChat[n]=a.USER_IN_CHAT[n]}for(var n in a.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[n]=a.USER_BLOCK_CHAT[n]}if(this.BXIM.messenger.currentTab==a.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(a.NETWORK_ID!=""){this.BXIM.messenger.currentTab=a.USER_ID;if(this.MobileActionEqual("RECENT")){for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(this.BXIM.messenger.recent[n].userId==a.NETWORK_ID){this.BXIM.messenger.recent[n].userId=a.USER_ID;this.BXIM.messenger.recent[n].recipientId=a.USER_ID;this.BXIM.messenger.recent[n].senderId=a.USER_ID}}s.MessengerCommon.userListRedraw()}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:a.NETWORK_ID,USER_ID:a.USER_ID,USER:this.BXIM.messenger.users[a.USER_ID]})}}s.MessengerCommon.drawTab(a.USER_ID,this.BXIM.messenger.currentTab==a.USER_ID);if(this.BXIM.messenger.currentTab==a.USER_ID&&this.BXIM.messenger.readedList[a.USER_ID])s.MessengerCommon.drawReadMessage(a.USER_ID,this.BXIM.messenger.readedList[a.USER_ID].messageId,this.BXIM.messenger.readedList[a.USER_ID].date,false);this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(a.USER_ID,true,false)}}else{this.BXIM.messenger.redrawTab[t]=true;if(a.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}else if(a.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadLastMessage(t,r)},this),2e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.loadLastMessage(t,r)},this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}}},this);var n=s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:90,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:r?"Y":"N",USER_ID:t,USER_LOAD:r?this.BXIM.messenger.chat[t.toString().substr(4)]&&this.BXIM.messenger.chat[t.toString().substr(4)].fake?"Y":"N":"Y",TAB:this.BXIM.messenger.currentTab,READ:this.isMobile()||this.BXIM.isFocus()?"Y":"N",MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!r&&this.BXIM.messenger.users[t].searchMark?this.BXIM.messenger.users[t].searchMark:"",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:a,onprogress:function(e){if(e.position==0&&e.totalSize==0){i()}},onfailure:i})};s.MessengerCommon.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;this.BXIM.messenger.currentTab=e;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="call")this.BXIM.messenger.openCallFlag=true}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanel2.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanel3.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanel2.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanel3.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r!=false;var a=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){this.BXIM.messenger.redrawTab[e]=false}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")})]})]}if(a.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:a})}if(t)this.BXIM.messenger.extraClose();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){if(this.BXIM.settings.loadLastMessage){this.loadLastMessage(e,this.BXIM.messenger.openChatFlag)}else{if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.loadChatData(e.toString().substr(4));else s.MessengerCommon.loadUserData(e);delete this.BXIM.messenger.redrawTab[e];this.drawTab(e,true)}}else{this.drawTab(e,true)}if(!this.BXIM.messenger.redrawTab[e]){if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate(function(t){if(t){s.MessengerCommon.readMessage(e)}},this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}if(!this.isMobile()&&r)this.BXIM.webrtc.callOverlayToggleSize(true);s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){app.onCustomEvent("onImDialogOpen",{id:e})}};s.MessengerCommon.prototype.drawTab=function(e,t){if(!e){e=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;if(this.BXIM.messenger.openChatFlag){var r=e.toString().substr(4);if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].type=="open"){if(!s.MessengerCommon.userInChat(r)){if(this.isMobile()){app.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+r,force:this.BXIM.messenger.redrawTab[e]?false:true})}else{s.PULL.extendWatch("IM_PUBLIC_"+r,this.BXIM.messenger.redrawTab[e]?false:true)}}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")})]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));else this.BXIM.messenger.showMessage[e]=[];for(var i=0;i<this.BXIM.messenger.showMessage[e].length;i++)s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][i]],false);t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var a=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(a)this.BXIM.messenger.popupMessengerBody.scrollTop=a.offsetTop-60-this.BXIM.messenger.popupMessengerBodyWrap.offsetTop;else this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}delete this.BXIM.messenger.redrawTab[e]};s.MessengerCommon.prototype.sendMessageAjax=function(t,r,i,a){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;a=a==true;this.BXIM.messenger.sendMessageFlag++;s.MessengerCommon.recentListAdd({id:"temp"+t,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:s.MessengerCommon.prepareText(i,true),userId:r,params:{}},true);var n=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_SEND_MESSAGE:"Y",CHAT:a?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(n){this.BXIM.messenger.sendMessageFlag--;if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[n.TMP_ID].text=n.SEND_MESSAGE;this.BXIM.messenger.message[n.TMP_ID].id=n.ID;this.BXIM.messenger.message[n.TMP_ID].date=parseInt(n.SEND_DATE);if(n.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[n.TMP_ID].params=n.SEND_MESSAGE_PARAMS}this.BXIM.messenger.message[n.ID]=this.BXIM.messenger.message[n.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==n.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=n.ID;delete this.BXIM.messenger.message[n.TMP_ID];var o=this.BXIM.messenger.message[n.ID];var l=s.util.array_search(""+n.TMP_ID+"",this.BXIM.messenger.showMessage[n.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[n.RECIPIENT_ID][l])this.BXIM.messenger.showMessage[n.RECIPIENT_ID][l]=""+n.ID+"";for(var h=0;h<this.BXIM.messenger.recent.length;h++){if(this.BXIM.messenger.recent[h].id==n.TMP_ID){this.BXIM.messenger.recent[h].id=""+n.ID+"";break}}if(n.RECIPIENT_ID==this.BXIM.messenger.currentTab){var m=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(m){m.setAttribute("data-messageid",""+n.ID+"");if(m.getAttribute("data-blockmessageid")==""+n.TMP_ID+""){m.setAttribute("data-blockmessageid",""+n.ID+"")}else{var g=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+n.TMP_ID+""}},true);if(g){g.setAttribute("data-blockmessageid",""+n.ID+"")}}}var I=s("im-message-"+n.TMP_ID);if(I){I.id="im-message-"+n.ID;I.innerHTML=s.MessengerCommon.prepareText(n.SEND_MESSAGE,false,true,true);if(n.SEND_MESSAGE_PARAMS&&n.SEND_MESSAGE_PARAMS.ATTACH){var M=s.MessengerCommon.drawAttach(this.BXIM.messenger.message[n.ID].chatId,n.SEND_MESSAGE_PARAMS.ATTACH);if(M.length>0){M=s.create("div",{props:{className:"bx-messenger-attach-box"},children:M});if(I.nextElementSibling){I.parentNode.insertBefore(M,I.nextElementSibling)}else{I.parentNode.appendChild(M)}}}}var p=this.BXIM.messenger.users[o.senderId];var c=s.findChildByClassName(m,"bx-messenger-content-item-date");if(c)c.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(o.date,s.MessengerCommon.getDateFormatType("MESSAGE"));s.MessengerCommon.clearProgessMessage(n.ID)}if(this.BXIM.messenger.history[n.RECIPIENT_ID])this.BXIM.messenger.history[n.RECIPIENT_ID].push(o.id);else this.BXIM.messenger.history[n.RECIPIENT_ID]=[o.id];this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(s.PULL){s.PULL.setUpdateStateStepCount(2,5)}s.MessengerCommon.updateStateVar(n,true,true);s.localStorage.set("msm",{id:n.ID,recipientId:n.RECIPIENT_ID,date:n.SEND_DATE,text:n.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:n.MESSAGE,USERS_MESSAGE:n.USERS_MESSAGE,USERS:n.USERS,USER_IN_GROUP:n.USER_IN_GROUP,WO_USER_IN_GROUP:n.WO_USER_IN_GROUP},5);if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}if(!this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw()}else{if(n.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),2e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var m=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var c=s.findChildByClassName(m,"bx-messenger-content-item-date");if(c){if(n.ERROR=="SESSION_ERROR"||n.ERROR=="AUTHORIZE_ERROR"||n.ERROR=="UNKNOWN_ERROR"||n.ERROR=="IM_MODULE_NOT_INSTALLED")c.innerHTML=s.message("IM_M_NOT_DELIVERED");else c.innerHTML=n.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",n.ERROR,n.TMP_ID,n.SEND_DATE,n.SEND_MESSAGE,n.RECIPIENT_ID]);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof n=="object"&&n.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(o){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true},this)})};s.MessengerCommon.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var t=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++){var i=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]];if(!i||i.id.indexOf("temp")!=0)continue;i.text=s.MessengerCommon.prepareTextBack(i.text);t.push(i)}if(t.length<=0)return false;t.sort(function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}});for(var r=0;r<t.length;r++){var a=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+t[r].id+""}},true);var n=s.findChildByClassName(a,"bx-messenger-content-item-date");if(n)n.innerHTML=s.message("IM_M_DELIVERED");this.sendMessageRetryTimeout(t[r],100*r)}};s.MessengerCommon.prototype.sendMessageRetryTimeout=function(e,t){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate(function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),t)};s.MessengerCommon.prototype.getLastMessageInDialog=function(e){var s=false;if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0){var t=this.BXIM.messenger.showMessage[e][this.BXIM.messenger.showMessage[e].length-1];s=this.BXIM.messenger.message[t]}return s};s.MessengerCommon.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].type!="open")return false;if(s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e])return false;t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var a=[];for(var n=0;n<this.BXIM.messenger.message[e].params.LIKE.length;n++){if(this.BXIM.messenger.message[e].params.LIKE[n]!=this.BXIM.userId){a.push(this.BXIM.messenger.message[e].params.LIKE[n])}}this.BXIM.messenger.message[e].params.LIKE=a;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var h=s.findChildByClassName(l,"bx-messenger-content-item-like");var m=s.findChildByClassName(l,"bx-messenger-content-like-digit",false);var g=s.findChildByClassName(l,"bx-messenger-content-like-button",false);if(r){g.innerHTML=s.message("IM_MESSAGE_DISLIKE");s.addClass(h,"bx-messenger-content-item-liked")}else{g.innerHTML=s.message("IM_MESSAGE_LIKE");s.removeClass(h,"bx-messenger-content-item-liked")}if(o>0){m.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(m,"bx-messenger-content-like-digit-off")}else{m.setAttribute("title","");s.addClass(m,"bx-messenger-content-like-digit-off")}m.innerHTML=o}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)},this),onfailure:s.delegate(function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false},this)})},this),1e3)}return true};s.MessengerCommon.prototype.messageIsLike=function(e){return typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};s.MessengerCommon.prototype.checkEditMessage=function(e){var t=false;if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].senderId==this.BXIM.userId&&parseInt(this.BXIM.messenger.message[e].date)+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){t=true}return t};s.MessengerCommon.prototype.editMessageAjax=function(e,t){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e))return false;if(t==s.MessengerCommon.prepareTextBack(this.BXIM.messenger.message[e].text,true))return false;t=t.replace("    ","	");t=s.util.trim(t);if(t.length<=0){s.MessengerCommon.deleteMessageAjax(e);return false}t=s.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,t);s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:e,MESSAGE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)})};s.MessengerCommon.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e))return false;s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};s.MessengerCommon.prototype.drawAttach=function(e,t,r){if(!t||t.length==0)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var a=this.getUserIdByChatId(e);var n=[];for(var o=0;o<i.length;o++){var l=i[o];var h="";if(typeof l.COLOR!="undefined"){h=l.COLOR}else if(a&&this.BXIM.messenger.users[a]){h=this.BXIM.messenger.users[a].color}else if(this.BXIM.messenger.chat[e]){h=this.BXIM.messenger.chat[e].color}else if(this.BXIM.messenger.users[this.BXIM.userId]){h=this.BXIM.messenger.users[this.BXIM.userId].color}if(typeof l["BLOCKS"]!="object"){continue}var m=[];for(var g=0;g<l["BLOCKS"].length;g++){var I=l["BLOCKS"][g];var M=null;if(I.USER&&I.USER.length>0){var p=[];for(var c=0;c<I.USER.length;c++){var d=null;if(I.USER[c].NETWORK_ID){d=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":I.USER[c].NETWORK_ID},html:I.USER[c].NAME})}else if(I.USER[c].USER_ID){d=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(I.USER[c].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-chatId":I.USER[c].USER_ID},html:I.USER[c].NAME})}else if(I.USER[c].CHAT_ID){d=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":I.USER[c].CHAT_ID},html:I.USER[c].NAME})}else if(I.USER[c].LINK){d=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(I.USER[c].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},html:I.USER[c].NAME})}else{d=s.create("span",{props:{className:"bx-messenger-attach-user-name"},html:I.USER[c].NAME})}var u=s.create("span",{props:{className:"bx-messenger-attach-user"},children:[s.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[I.USER[c].AVATAR?s.create("img",{attrs:{src:s.util.htmlspecialcharsback(I.USER[c].AVATAR)},props:{className:"bx-messenger-attach-user-avatar-img"}}):s.create("span",{attrs:{style:"background-color: "+h},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+(I.USER[c].AVATAR_TYPE=="CHAT"?"chat":"user")+"-avatar-default "}})]}),d]});p.push(u)}M=s.create("span",{props:{className:"bx-messenger-attach-users"},children:p})}else if(I.LINK&&I.LINK.length>0){var f=[];for(var c=0;c<I.LINK.length;c++){var d=s.create("span",{props:{className:"bx-messenger-attach-link-name"},html:I.LINK[c].NAME?I.LINK[c].NAME:I.LINK[c].LINK});if(I.LINK[c].NETWORK_ID){
d=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":I.LINK[c].NETWORK_ID},children:[d]})}else if(I.LINK[c].USER_ID){d=s.create("span",{props:{className:"bx-messenger-ajax "+(I.LINK[c].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-chatId":I.LINK[c].USER_ID},children:[d]})}else if(I.LINK[c].CHAT_ID){d=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":I.LINK[c].CHAT_ID},children:[d]})}else{d=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(I.LINK[c].LINK),target:"_blank"},children:[d]})}var B=null;if(I.LINK[c].DESC){B=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:I.LINK[c].DESC})}var X=null;if(I.LINK[c].HTML){X=s.create("div",{props:{className:"bx-messenger-attach-link-html"},html:I.LINK[c].HTML})}else if(I.LINK[c].PREVIEW){X=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(I.LINK[c].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-file-image-text"}})]});X=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(I.LINK[c].LINK),target:"_blank"},children:[X]})}var E=s.create("span",{props:{className:"bx-messenger-attach-link"+(I.LINK[c].PREVIEW?" bx-messenger-attach-link-with-preview":"")},children:[d,B,X]});f.push(E)}M=s.create("span",{props:{className:"bx-messenger-attach-links"},children:f})}else if(I.MESSAGE&&I.MESSAGE.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:I.MESSAGE})}else if(I.HTML&&I.HTML.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:I.HTML})}else if(I.GRID&&I.GRID.length>0){var b=[];for(var c=0;c<I.GRID.length;c++){var C=I.GRID[c].VALUE;if(I.GRID[c].USER_ID){C='<span class="bx-messenger-ajax '+(I.GRID[c].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+I.GRID[c].USER_ID+'">'+C+"</span>"}else if(I.GRID[c].CHAT_ID){C='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+I.GRID[c].CHAT_ID+'">'+C+"</span>"}else if(I.GRID[c].LINK){C='<a href="'+I.GRID[c].LINK+'" target="_blank"">'+C+"</a>"}var S=I.GRID[c].WIDTH?"width: "+I.GRID[c].WIDTH+"px":"";var _=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+I.GRID[c].DISPLAY.toLowerCase()},attrs:{style:I.GRID[c].DISPLAY=="LINE"?S:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:I.GRID[c].DISPLAY=="ROW"?S:""},html:I.GRID[c].NAME}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:I.GRID[c].COLOR?"color: "+I.GRID[c].COLOR:""},html:C})]});b.push(_)}M=s.create("span",{props:{className:"bx-messenger-attach-blocks"},children:b})}else if(I.DELIMITER){var T="";if(I.DELIMITER.SIZE){T+="width: "+I.DELIMITER.SIZE+"px;"}if(I.DELIMITER.COLOR){T+="background-color: "+I.DELIMITER.COLOR}if(T){T={style:T}}M=s.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:T})}else if(I.IMAGE&&I.IMAGE.length>0){var v=[];for(var c=0;c<I.IMAGE.length;c++){if(!I.IMAGE[c].NAME){I.IMAGE[c].NAME=""}if(!I.IMAGE[c].PREVIEW){I.IMAGE[c].PREVIEW=I.IMAGE[c].LINK}var R=s.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:s.util.htmlspecialcharsback(I.IMAGE[c].LINK),target:"_blank",title:I.IMAGE[c].NAME},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(I.IMAGE[c].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-file-image-text"}})]});v.push(R)}M=s.create("span",{props:{className:"bx-messenger-attach-images"},children:v})}else if(I.FILE&&I.FILE.length>0){var L=[];for(var c=0;c<I.FILE.length;c++){var A=I.FILE[c].NAME?I.FILE[c].NAME:I.FILE[c].LINK;if(this.isMobile()){if(A.length>20){A=A.substr(0,7)+"..."+A.substr(A.length-10,A.length)}}else{if(A.length>43){A=A.substr(0,20)+"..."+A.substr(A.length-20,A.length)}}A=s.create("span",{attrs:{title:I.FILE[c].NAME},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:A})]});var x=s.create("div",{props:{className:"bx-messenger-file"},children:[s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:s.util.htmlspecialcharsback(I.FILE[c].LINK),target:"_blank"},children:[A]}),I.FILE[c].SIZE?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(I.FILE[c].SIZE)}):null]}),s.create("div",{props:{className:"bx-messenger-file-download"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(I.FILE[c].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})]})]});L.push(x)}M=s.create("span",{props:{className:"bx-messenger-attach-files"},children:L})}m.push(M)}if(m.length>0){n.push(s.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:"border-color: "+h},children:m}))}}return n};s.MessengerCommon.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable||!e||!t)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var a=this.isMobile()?"mobile":this.BXIM.desktop.ready()?"desktop":"default";var n=true;var o=[];for(var l=0;l<i.length;l++){var h=this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][i[l]];if(!h){var h={id:i[l],chatId:e};var m=r.boxId?r.boxId:"im-file";o.push(s.create("div",{attrs:{id:m+"-"+h.id,"data-chatId":h.chatId,"data-fileId":h.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[s.create("span",{props:{className:"bx-messenger-file-deleted"},html:s.message("IM_F_DELETED")})]}));continue}if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(h.status,r.status)){continue}}var g=null;if(h.type=="image"&&(h.preview||h.urlPreview[a])){var I=null;if(this.isMobile()&&h.preview&&typeof h.preview!="string"){if(h.urlPreview[a]){var I=s.create("div",{attrs:{src:h.urlPreview[a]},props:{className:"bx-messenger-file-image-text bx-messenger-hide"}})}}var M=null;if(h.preview&&typeof h.preview!="string"){M=h.preview;if(h.urlPreview[a]){h.preview=""}}else{M=s.create("img",{attrs:{src:h.urlPreview[a]?h.urlPreview[a]:h.preview},props:{className:"bx-messenger-file-image-text"}})}if(n&&h.urlShow[a]){if(this.isMobile()&&h.urlPreview[a]){g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate(function(){this.BXIM.messenger.openPhotoGallery(h.urlPreview[a])},this)},props:{className:"bx-messenger-file-image-src"},children:[I,M]})]}),s.create("br")]})}else{g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{attrs:{href:h.urlShow[a],target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[M]})]}),s.create("br")]})}}else{g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[M]})]}),s.create("br")]})}}var p=h.name;if(this.isMobile()){if(p.length>20){p=p.substr(0,7)+"..."+p.substr(p.length-10,p.length)}}else{if(p.length>43){p=p.substr(0,20)+"..."+p.substr(p.length-20,p.length)}}var c=s.create("span",{attrs:{title:h.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:p})]});if(n&&(h.urlShow[a]||h.urlDownload[a])){if(this.isMobile())c=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:h.urlDownload["mobile"],filename:p})}},children:[c]});else c=s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:h.urlShow?h.urlShow[a]:h.urlDownload[a],target:"_blank"},children:[c]})}c=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[c,s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(h.size)})]});var d=null;if(h.status=="done"){if(!this.isMobile()){d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[!h.urlDownload||!n?null:s.create("a",{attrs:{href:h.urlDownload[a],target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")}),!h.urlDownload||!this.BXIM.disk.enable?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate(function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})},this)}})]})}else{d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(h.status=="upload"){var u={};var f="";var B=null;var X="";var E="";if(h.authorId==this.BXIM.userId&&h.progress>=0){E=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",h.progress);u={width:h.progress+"%"};B=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{E=s.message("IM_F_UPLOAD");X=" bx-messenger-file-progress-infinite"}d=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:E},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+X},style:u})]}),B]})}else if(h.status=="error"){d=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:h.errorText?h.errorText:s.message("IM_F_ERROR")})}if(!d)return false;if(i.length==1&&r.showInner=="Y"){o=[g,c,d]}else{var m=r.boxId?r.boxId:"im-file";o.push(s.create("div",{attrs:{id:m+"-"+h.id,"data-chatId":h.chatId,"data-fileId":h.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[g,c,d]}))}}return o};s.MessengerCommon.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var a=s(i+"-"+t);if(a){var n=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(n){a.innerHTML="";s.adjust(a,{children:n})}}};s.MessengerCommon.prototype.diskChatDialogFileInited=function(e,t,r){var i=r.form.CHAT_ID.value;if(!this.BXIM.disk.files[i])this.BXIM.disk.files[i]={};this.BXIM.disk.files[i][e]={id:e,tempId:e,chatId:i,date:s.MessengerCommon.getNowDate(),type:t.isImage?"image":"file",preview:t.isImage?t.canvas:"",name:t.name,size:t.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.BXIM.disk.filesRegister[i])this.BXIM.disk.filesRegister[i]={};this.BXIM.disk.filesRegister[i][e]={id:e,type:this.BXIM.disk.files[i][e].type,mimeType:t.file.type,name:this.BXIM.disk.files[i][e].name,size:this.BXIM.disk.files[i][e].size};this.diskChatDialogFileRegister(i)};s.MessengerCommon.prototype.diskChatDialogFileRegister=function(t){clearTimeout(this.BXIM.disk.timeout[t]);this.BXIM.disk.timeout[t]=setTimeout(s.delegate(function(){var r=0;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].type!="private"){r="chat"+t}else{for(var i in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[i]==t){r=i;break}}}if(!r)return false;var a=[];for(var n in this.BXIM.disk.filesRegister[t]){a.push(n)}var o="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[o]={id:o,chatId:t,senderId:this.BXIM.userId,recipientId:r,date:s.MessengerCommon.getNowDate(),text:"",params:{FILE_ID:a}};if(!this.BXIM.messenger.showMessage[r])this.BXIM.messenger.showMessage[r]=[];this.BXIM.messenger.showMessage[r].push(o);s.MessengerCommon.drawMessage(r,this.BXIM.messenger.message[o]);s.MessengerCommon.drawProgessMessage(o);this.recentListAdd({id:o,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:"["+s.message("IM_F_FILE")+"]",userId:r,params:{}},true);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){if(typeof s.PULL!="undefined"&&typeof s.PULL.tryConnectDelay=="function"){s.PULL.tryConnectDelay()}return s.message("IM_F_EFP")};s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:t,RECIPIENT_ID:r,MESSAGE_TMP_ID:o,FILES:JSON.stringify(this.BXIM.disk.filesRegister[t]),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(i){if(i.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[o];s.MessengerCommon.drawTab(r);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[t]={};if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear();return false}this.BXIM.messenger.sendMessageFlag--;var a=[];var n={};for(var l in i.FILE_ID){var h=i.FILE_ID[l];delete this.BXIM.disk.filesRegister[i.CHAT_ID][h.TMP_ID];if(parseInt(h.FILE_ID)>0){n[h.TMP_ID]=h.FILE_ID;this.BXIM.disk.filesProgress[h.TMP_ID]=h.FILE_ID;this.BXIM.disk.filesMessage[h.TMP_ID]=i.MESSAGE_ID;this.BXIM.disk.files[i.CHAT_ID][h.FILE_ID]={};for(var m in this.BXIM.disk.files[i.CHAT_ID][h.TMP_ID])this.BXIM.disk.files[i.CHAT_ID][h.FILE_ID][m]=this.BXIM.disk.files[i.CHAT_ID][h.TMP_ID][m];this.BXIM.disk.files[i.CHAT_ID][h.FILE_ID]["id"]=h.FILE_ID;delete this.BXIM.disk.files[i.CHAT_ID][h.TMP_ID];this.BXIM.disk.files[i.CHAT_ID][h.FILE_ID]["name"]=h.FILE_NAME;if(s("im-file-"+h.TMP_ID)){s("im-file-"+h.TMP_ID).setAttribute("data-fileId",h.FILE_ID);s("im-file-"+h.TMP_ID).id="im-file-"+h.FILE_ID;s.MessengerCommon.diskRedrawFile(i.CHAT_ID,h.FILE_ID)}a.push(h.FILE_ID)}else{this.BXIM.disk.files[i.CHAT_ID][h.TMP_ID]["status"]="error";s.MessengerCommon.diskRedrawFile(i.CHAT_ID,h.TMP_ID)}}this.BXIM.messenger.message[i.MESSAGE_ID]=s.clone(this.BXIM.messenger.message[i.MESSAGE_TMP_ID]);this.BXIM.messenger.message[i.MESSAGE_ID]["id"]=i.MESSAGE_ID;this.BXIM.messenger.message[i.MESSAGE_ID]["params"]["FILE_ID"]=a;if(this.BXIM.messenger.popupMessengerLastMessage==i.MESSAGE_TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=i.MESSAGE_ID;delete this.BXIM.messenger.message[i.MESSAGE_TMP_ID];var g=s.util.array_search(""+i.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[i.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[i.RECIPIENT_ID][g])this.BXIM.messenger.showMessage[i.RECIPIENT_ID][g]=""+i.MESSAGE_ID+"";if(s("im-message-"+i.MESSAGE_TMP_ID)){s("im-message-"+i.MESSAGE_TMP_ID).id="im-message-"+i.MESSAGE_ID;var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+i.MESSAGE_TMP_ID}},true);if(I){I.setAttribute("data-messageid",""+i.MESSAGE_ID+"");if(I.getAttribute("data-blockmessageid")==""+i.MESSAGE_TMP_ID)I.setAttribute("data-blockmessageid",""+i.MESSAGE_ID+"")}else{var M=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+i.MESSAGE_TMP_ID}},true);if(M){M.setAttribute("data-blockmessageid",""+i.MESSAGE_ID+"")}}var p=s.findChildByClassName(I,"bx-messenger-content-item-date");if(p)p.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(this.BXIM.messenger.message[i.MESSAGE_ID].date,s.MessengerCommon.getDateFormatType("MESSAGE"))}s.MessengerCommon.clearProgessMessage(i.MESSAGE_ID);if(this.BXIM.messenger.history[i.RECIPIENT_ID])this.BXIM.messenger.history[i.RECIPIENT_ID].push(i.MESSAGE_ID);else this.BXIM.messenger.history[i.RECIPIENT_ID]=[i.MESSAGE_ID];this.BXIM.messenger.popupMessengerFileFormRegChatId.value=i.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=i.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(n);this.BXIM.disk.formAgents["imDialog"].submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[o];this.BXIM.disk.filesRegister[t]={};s.MessengerCommon.drawTab(r);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear()},this)});this.BXIM.disk.fileTmpId++},this),500)};s.MessengerCommon.prototype.diskChatDialogFileStart=function(e,t,r,i){var a=this.BXIM.disk.filesProgress[e.id];var n=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[n.REG_CHAT_ID][a])return false;this.BXIM.disk.files[n.REG_CHAT_ID][a].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n.REG_CHAT_ID,a)};s.MessengerCommon.prototype.diskChatDialogFileProgress=function(e,t,r,i){var a=this.BXIM.disk.filesProgress[e.id];var n=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[n.REG_CHAT_ID][a])return false;this.BXIM.disk.files[n.REG_CHAT_ID][a].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n.REG_CHAT_ID,a)};s.MessengerCommon.prototype.diskChatDialogFileDone=function(t,r,i,a){if(!this.BXIM.disk.files[r.file.fileChatId][r.file.fileId])return false;if(this.BXIM.disk.files[r.file.fileChatId]&&this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]){r.file.fileParams["preview"]=this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]["preview"]}if(!this.BXIM.disk.files[r.file.fileChatId])this.BXIM.disk.files[r.file.fileChatId]={};this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]=r.file.fileParams;s.MessengerCommon.diskRedrawFile(r.file.fileChatId,r.file.fileId);delete this.BXIM.disk.filesMessage[r.file.fileTmpId];e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogFileError=function(t,r,i,a){var n=this.BXIM.disk.filesProgress[t.id];var o=i.streams.packages.getItem(a).data;if(!this.BXIM.disk.files[o.REG_CHAT_ID][n])return false;t.deleteFile();this.BXIM.disk.files[o.REG_CHAT_ID][n].status="error";this.BXIM.disk.files[o.REG_CHAT_ID][n].errorText=r.error;s.MessengerCommon.diskRedrawFile(o.REG_CHAT_ID,n);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogUploadError=function(t,r,i){var a=JSON.parse(t.post.REG_PARAMS);var n={};for(var o in a){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID]){delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][o];delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][a[o]]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,a[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UNREGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t.post.REG_CHAT_ID,FILES:t.post.REG_PARAMS,MESSAGES:JSON.stringify(n),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.getRecipientByChatId(t.post.REG_CHAT_ID))};s.MessengerCommon.prototype.pullPhoneEvent=function(){s.addCustomEvent(this.isMobile()?"onPull-voximplant":"onPullEvent-voximplant",s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command;console.info("pull info: ",e,t)}if(e=="invite"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(s.localStorage.get("viInitedCall"))return false;if(false&&this.BXIM.webrtc.callInit&&!this.BXIM.webrtc.callActive&&t.typeConnect!="queue"){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");if(!this.isMobile()){this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone")}this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();this.BXIM.webrtc.callOverlayClose(false)}if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive)return false;if(this.isMobile()||this.BXIM.desktop.ready()||!this.BXIM.desktop.ready()&&!this.BXIM.desktopStatus||this.BXIM.desktop.run()&&!this.BXIM.desktop.ready()&&this.BXIM.desktopStatus){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&t.portalCallData){for(var r in t.portalCallData.users)this.BXIM.messenger.users[r]=t.portalCallData.users[r];for(var r in t.portalCallData.hrphoto)this.BXIM.messenger.hrphoto[r]=t.portalCallData.hrphoto[r];t.callerId=this.BXIM.messenger.users[t.portalCallUserId].name;t.phoneNumber="";if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5e3);if(!this.isMobile()&&this.BXIM.desktop.run()){s.desktop.changeTab("im")}s.MessengerCommon.phoneCommand("wait",{CALL_ID:t.callId});this.BXIM.webrtc.phoneIncomingWait(t.chatId,t.callId,t.callerId,t.phoneNumber)}console.log("isMobile",this.isMobile()?"Y":"N","desktopReady",this.BXIM.desktop&&this.BXIM.desktop.ready()?"Y":"N","isFocus",this.BXIM.isFocus("all")?"Y":"N");if(!this.isMobile()&&this.BXIM.desktop.ready()&&!this.BXIM.isFocus("all")){var i={users:{},chat:{},userInChat:{},hrphoto:{},phoneCrm:t.CRM};this.BXIM.desktop.openTopmostWindow("callNotifyWaitDesktop","BXIM.webrtc.phoneIncomingWaitDesktop("+t.chatId+",'"+t.callId+"', '"+t.callerId+"', '"+t.phoneNumber+"', true);",i,"im-desktop-call")}}else if(e=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();this.BXIM.webrtc.callOverlayClose(true);this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=t.callId}else if(e=="timeout"){if(this.BXIM.webrtc.phoneCallId!=t.callId)return false;clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");var a=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var n=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(a&&t.failedCode==486){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_BUSY_PHONE"));if(this.isMobile()){this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.CALLBACK)}else{this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}}else if(a&&t.failedCode==480){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_NA_PHONE"));if(this.isMobile()){this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.webrtc.callOverlayButtons([{title:s.message(this.BXIM.webrtc.phoneDeviceCall()?"IM_M_CALL_BTN_DEVICE_TITLE":"IM_M_CALL_BTN_DEVICE_OFF_TITLE"),id:"bx-messenger-call-overlay-button-device-error",className:"bx-messenger-call-overlay-button-device"+(this.BXIM.webrtc.phoneDeviceCall()?"":" bx-messenger-call-overlay-button-device-off"),events:{click:s.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();this.BXIM.webrtc.phoneDeviceCall(!this.BXIM.webrtc.phoneDeviceCall());this.BXIM.webrtc.phoneCall(n)},this)},hide:this.BXIM.webrtc.phoneDeviceActive&&this.BXIM.webrtc.enabled?false:true},{text:s.message("IM_M_CALL_BTN_CLOSE"),className:"bx-messenger-call-overlay-button-close",events:{click:s.delegate(function(){this.BXIM.webrtc.callOverlayClose()},this)}}])}}else{if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_DECLINE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.webrtc.callOverlayClose(false)}}}else if(e=="outgoing"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(!this.isMobile()&&this.BXIM.desktopStatus&&!this.BXIM.desktop.ready())return false;if(!this.isMobile()&&this.BXIM.desktop.ready()){s.desktop.changeTab("im");s.desktop.windowCommand("show")}this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==t.phoneNumber||t.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneNumber=t.phoneNumber;if(t.external&&this.BXIM.webrtc.phoneCallId==t.callIdTmp||!this.BXIM.webrtc.phoneCallId){this.BXIM.webrtc.phoneCallExternal=t.external?true:false;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){if(!this.BXIM.webrtc.phoneCallId){this.BXIM.webrtc.callOverlayProgress("wait");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_WAIT_PHONE"));if(!this.isMobile()&&this.BXIM.desktop.ready()){s.desktop.changeTab("im");s.desktop.windowCommand("show");this.BXIM.desktop.closeTopmostWindow()}}else{this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"))}}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=t.CRM;if(this.BXIM.webrtc.phonePortalCall&&this.BXIM.messenger.users[t.portalCallUserId]){if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}else{this.BXIM.webrtc.callOverlayTitleBlock.innerHTML=s.message("IM_M_CALL_VOICE_TO").replace("#USER#",this.BXIM.messenger.users[t.portalCallUserId].name)}}}this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}else if(!this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallInvite(t.phoneNumber);this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}}else if(e=="start"){this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==t.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else if(this.BXIM.webrtc.phoneCallId==t.callId&&t.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){if(!this.isMobile()){if(this.BXIM.desktop.ready()){s.desktop.changeTab("im");s.desktop.windowCommand("show")}this.BXIM.messenger.openMessenger(this.BXIM.messenger.currentTab)}this.BXIM.webrtc.phoneCallDevice="PHONE";this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else if(e=="hold"||e=="unhold"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.phoneHolded=e=="hold"}}else if(e=="update_crm"){if(this.BXIM.webrtc.phoneCallId==t.callId&&t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}}else if(e=="inviteTransfer"){if(this.isMobile())return false;if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(!this.BXIM.webrtc.callInit&&!this.BXIM.webrtc.callActive){if(this.BXIM.desktop.ready()||!this.BXIM.desktop.ready()&&!this.BXIM.desktopStatus||this.BXIM.desktop.run()&&!this.BXIM.desktop.ready()&&this.BXIM.desktopStatus){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}this.BXIM.repeatSound("ringtone",5e3);s.MessengerCommon.phoneCommand("waitTransfer",{CALL_ID:t.callId});if(this.BXIM.desktop.run())s.desktop.changeTab("im");this.BXIM.webrtc.phoneTransferEnabled=true;this.BXIM.webrtc.phoneIncomingWait(t.chatId,t.callId,t.callerId)}if(this.BXIM.desktop.ready()&&!this.BXIM.isFocus("all")){var i={users:{},chat:{},userInChat:{},hrphoto:{},phoneCrm:t.CRM};this.BXIM.desktop.openTopmostWindow("callNotifyWaitDesktop","BXIM.webrtc.phoneIncomingWaitDesktop("+t.chatId+",'"+t.callId+"', '"+t.callerId+"');",i,"im-desktop-call")}}}else if(e=="cancelTransfer"||e=="timeoutTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId&&!this.BXIM.webrtc.callSelfDisabled){this.BXIM.webrtc.callInit=false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();this.BXIM.webrtc.callOverlayClose()}}else if(e=="declineTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.errorInviteTransfer()}}else if(e=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId){if(t.transferUserId!=this.BXIM.userId||this.isMobile()){this.BXIM.webrtc.successInviteTransfer()}else{this.BXIM.webrtc.phoneTransferEnabled=false;s.localStorage.set("vite",false,1);if(t.callDevice=="PHONE"){this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.desktop.ready()){s.desktop.changeTab("im");s.desktop.windowCommand("show")}if(this.isMobile()){this.BXIM.messenger.openMessenger(this.BXIM.messenger.currentTab)}this.BXIM.webrtc.phoneCallDevice="PHONE";this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}}}}else if(e=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=t.active=="Y"}},this))};s.MessengerCommon.prototype.phoneCommand=function(e,t,r){if(!this.BXIM.webrtc.phoneSupport())return false;r=r!=false;t=typeof t=="object"?t:{};s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:r,data:{IM_PHONE:"Y",COMMAND:e,PARAMS:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};s.MessengerCommon.prototype.phoneCorrect=function(e){e=s.util.trim(e.toString());if(e.substr(0,2)=="+8"&&e.length>10){e="008"+e.substr(2)}e=e.replace(/[^0-9]/g,"");if(e.substr(0,2)=="80"||e.substr(0,2)=="81"||e.substr(0,2)=="82"){}else if(e.substr(0,2)=="00"&&e.length>=9){e=e.substr(2)}else if(e.substr(0,3)=="011"&&e.length>=10){e=e.substr(3)}else if(e.substr(0,1)=="8"&&e.length>=11){e="7"+e.substr(1)}else if(e.substr(0,1)=="0"&&e.length>=8){e=e.substr(1)}return e};s.MessengerCommon.prototype.phoneOnIncomingCall=function(e){if(this.BXIM.webrtc.phoneCurrentCall)return false;var t={};if(this.isMobile()){t=s.MobileVoximplantCall.events}else{t=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=e.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};s.MessengerCommon.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams["CALLER_ID"]="";this.BXIM.webrtc.phoneParams["USER_ID"]=this.BXIM.userId;

this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=s.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,JSON.stringify(this.BXIM.webrtc.phoneParams));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:s.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(!(e.HR_PHOTO.length==0)){for(var s in e.HR_PHOTO)this.BXIM.messenger.hrphoto[s]=e.HR_PHOTO[s];if(!this.isMobile()){this.BXIM.webrtc.callOverlayPhotoCompanion.setAttribute("data-userId",this.BXIM.webrtc.callOverlayUserId)}this.BXIM.webrtc.callOverlayUserId=e.DIALOG_ID;this.BXIM.webrtc.callOverlayUpdatePhoto()}else{this.BXIM.webrtc.callOverlayChatId=e.DIALOG_ID.substr(4)}if(!this.isMobile()){this.BXIM.messenger.openMessenger(e.DIALOG_ID);this.BXIM.webrtc.callOverlayToggleSize(false)}}},this)})};s.MessengerCommon.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){s.MessengerCommon.phoneCommand("deviceHungup",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneTransferEnabled&&this.BXIM.webrtc.phoneTransferUser==0){s.MessengerCommon.phoneCommand("declineTransfer",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand("skip",{CALL_ID:this.BXIM.webrtc.phoneCallId})}if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup()}catch(e){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad)this.BXIM.webrtc.popupKeyPad.close();if(this.BXIM.webrtc.popupTransferDialog)this.BXIM.webrtc.popupTransferDialog.close();s.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferUser=0;this.BXIM.webrtc.phoneTransferEnabled=false};s.MessengerCommon.prototype.phoneAuthorize=function(){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(t.HR_PHOTO){for(var r in t.HR_PHOTO)this.BXIM.messenger.hrphoto[r]=t.HR_PHOTO[r];this.BXIM.webrtc.callOverlayUpdatePhoto()}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);s.MobileVoximplant.loginWithOneTimeKey(t.LOGIN+"@"+t.SERVER,t.HASH)}else{this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER}this.BXIM.webrtc.phoneCallerID=t.CALLERID;this.BXIM.webrtc.phoneApiInit()}else if(t.ERROR=="AUTHORIZE_ERROR"&&(this.BXIM.desktop.ready()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),5e3);s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",t.ERROR,t.CODE);if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR]);this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(t.ERROR+(this.BXIM.webrtc.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+t.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))},this)})};s.MessengerCommon.prototype.phoneOnAuthResult=function(e){if(e.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE")return false;this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand(this.BXIM.webrtc.phoneTransferEnabled?"readyTransfer":"ready",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){s.MessengerCommon.phoneCallStart()}}else if(!this.isMobile()&&e.code==302){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:e.key,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE)this.BXIM.webrtc.callAbort(s.message("IM_PHONE_ERROR_CONNECT"));else this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+e.CODE+")":""));if(!this.isMobile()){this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()},this)})}else{if(e.code==401||e.code==400||e.code==403||e.code==404||e.code==302){this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;s.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneCallFinish();if(!this.isMobile()){this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}this.BXIM.webrtc.phoneLog("Authorize result","failed",e.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}};s.MessengerCommon.prototype.phoneOnCallFailed=function(e){this.BXIM.webrtc.phoneLog("Call failed",e.code,e.reason);var t=s.message("IM_PHONE_END");if(e.code==603){t=s.message("IM_PHONE_DECLINE")}else if(e.code==380){t=s.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){t=s.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){t=s.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){t=s.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){t=s.message("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){t=s.message("IM_PHONE_NO_EMERGENCY")}else{t=s.message("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){t=s.message("IM_PHONE_NO_EMERGENCY")}else{t=s.message("IM_PHONE_INCOMPLETED")}}else if(e.code==402){t=s.message("IM_PHONE_NO_MONEY")+(this.BXIM.bitrix24Admin?"<br />"+s.message("IM_PHONE_PAY_URL_NEW"):"")}else if(e.code==486&&this.BXIM.webrtc.phoneRinging>1){t=s.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){t=s.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){t=s.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}this.BXIM.webrtc.phoneCallFinish();if(e.code==408||e.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(t);if(!this.isMobile()){this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}};s.MessengerCommon.prototype.phoneOnCallDisconnected=function(e){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();if(this.isMobile()){this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_END"));this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.webrtc.callOverlayClose();this.BXIM.playSound("stop")}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}};s.MessengerCommon.prototype.phoneOnProgressToneStart=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"));this.BXIM.webrtc.phoneRinging++};s.MessengerCommon.prototype.phoneOnProgressToneStop=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};s.MessengerCommon.prototype.phoneOnConnectionEstablished=function(e){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};s.MessengerCommon.prototype.phoneOnConnectionFailed=function(e){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))};s.MessengerCommon.prototype.phoneOnConnectionClosed=function(e){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};s.MessengerCommon.prototype.phoneOnMicResult=function(e){this.BXIM.webrtc.phoneMicAccess=e.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",e.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow)this.BXIM.webrtc.callDialogAllow.close()}if(e.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.callOverlayButtons(this.BXIM.webrtc.buttonsOverlayClose)}}};s.MessengerCommon.prototype.phoneOnNetStatsReceived=function(e){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED")return false;var s=100-parseInt(e.stats.packetLoss);var t=this.BXIM.webrtc.callPhoneOverlayMeter(s);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PERCENT:s,GRADE:t}))};s.MessengerCommon.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;if(typeof e!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};s.MessengerCommon.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};s.MessengerCommon.prototype.getHrPhoto=function(e,s){var t="";if(e=="phone"){t="/bitrix/js/im/images/hidef-phone-v3.png"}else if(this.BXIM.messenger.hrphoto[e]){t=this.BXIM.messenger.hrphoto[e];if(this.BXIM.messenger.hrphoto[e]!="/bitrix/js/im/images/hidef-avatar-v3.png"){s=""}}else if(!this.BXIM.messenger.users[e]||this.BXIM.messenger.users[e].avatar==this.BXIM.pathToBlankImage){t="/bitrix/js/im/images/hidef-avatar-v3.png"}else{t=this.BXIM.messenger.users[e].avatar;s=""}return{src:t,color:s}};s.MessengerCommon=new s.MessengerCommon})(window);
//# sourceMappingURL=common.map.js